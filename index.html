<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Check-in App">
<title>Check-in WebApp Mobile</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ffffff">
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<!-- Thêm các thư viện của Firebase vào đây -->
<script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
:root { --primary:#2563eb; --danger:#dc2626; --danger-active:#e53e3e; --ok:#16a34a; --bg:#f6f7fb; --warn:#f59e0b; --gray-100:#f3f4f6; --gray-200: #e5e7eb; --gray-500:#6b7280; --gray-700:#374151; --text-light: #fff; --text-dark:#1f2937; }
* { box-sizing:border-box; margin:0; padding:0; font-family:'Be Vietnam Pro', system-ui, Arial, sans-serif; }
body { background:var(--bg); color:var(--text-dark); font-size: 14px; }
#login-view { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; }
.login-box { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 320px; }
.login-box h2 { margin-bottom: 20px; font-size: 20px; }
.login-box input { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 12px; text-align: center; }
.login-box button { width: 100%; padding: 12px; font-size: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
#login-by-code-btn { margin-top: 8px; background-color: var(--gray-700); }
#login-error { color: var(--danger); font-size: 14px; margin-top: 10px; height: 16px; }
#app-container { display: none; }
header { position:sticky; top:0; background:var(--text-light); border-bottom:1px solid #e5e7eb; padding:8px; z-index:100; display:flex; align-items:center; gap:8px; }
.tabs-container { display: flex; flex-grow: 1; gap: 8px; }
.tab { flex: 1; text-align: center; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; font-size: 14px; color: var(--text-light); opacity: 0.65; }
#tab-emp { background-color: var(--primary); }
#tab-admin { background-color: var(--danger); }
.tab.active { opacity: 1; box-shadow: inset 0 2px 4px rgba(0,0,0,0.15); }
#logout-btn, #game-btn, #font-size-btn { background: none; border: none; font-size: 18px; color: var(--gray-500); cursor: pointer; padding: 8px; }
main { padding:8px; max-width:480px; margin:0 auto; }
.card { background:var(--text-light); border-radius:8px; margin-bottom:6px; box-shadow:0 1px 4px rgba(0,0,0,0.06); overflow:hidden; border: 1px solid var(--gray-200); transition: opacity 0.3s ease-in-out; }
.card-header { display:flex; justify-content: space-between; align-items: center; gap:8px; padding: 6px 8px; border-bottom:1px solid var(--gray-100); }
.emp-info { display: flex; align-items: center; flex-grow: 1; overflow: hidden; }
.emp-name { font-weight:600; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-color: #eef2ff; padding: 2px 8px; border-radius: 6px; color: var(--primary); }
.header-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.status-badge { padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600; color: white; flex-shrink: 0; }
.status-working { background-color: var(--ok); } .status-on-break { background-color: var(--warn); } .status-pending { background-color: var(--gray-500); } .status-scheduled { background-color: var(--primary); }
.card-body { padding: 4px 8px; }
.status-section { display: flex; gap: 4px; flex-grow: 1; }
.status-item {
    background-color: var(--gray-100); padding: 6px 4px; border-radius: 4px;
    flex: 1;
    display: flex; justify-content: center; align-items: baseline; gap: 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    text-align: center;
}
.status-item-start { background-color: #eef2ff; } 
.status-item-break-count { background-color: #f0fdf4; } 
.status-item-total-break { background-color: #fefce8; }
.status-item-break-type { background-color: #faf5ff; }
.status-item.clickable { cursor: pointer; transition: background-color 0.2s; } .status-item.clickable:hover { background-color: #e5e7eb; }
.status-item .label { font-weight: 500; color: var(--gray-500); font-size: 10px; } 
.status-item .value { font-weight: 700; color: var(--text-dark); font-size: 11px; }
.status-item .value.break-count-value { color: var(--danger) !important; }
.status-item .value.break-total-value { color: var(--ok) !important; }
.action-buttons { display: flex; justify-content: center; align-items:center; flex-shrink: 0; gap: 4px; }
.btn { padding: 6px 10px; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; color: var(--text-light); width: auto; flex-grow: 1; transition: background-color 0.2s ease-in-out; }
.btn-alarm { background: var(--ok); padding: 6px 8px; flex-shrink: 0; width: auto; flex-grow: 0; }
.btn-start-break { background: var(--warn); } .btn-stop-break { background: var(--danger); } .btn:disabled { background-color: #d1d5db; cursor: not-allowed; }
.break-visualizer { padding: 4px 8px; min-height: 12px; }
.timer-container { display: none; width: 100%; background-color: #fef2f2; padding: 4px 8px; border-radius: 4px; }
.timer-display { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
.timer-text { font-size:12px; color:var(--danger); font-weight:500; flex-shrink: 0; font-variant-numeric: tabular-nums; min-width: 70px; }
.progress-container { flex-grow: 1; height:6px; background:#e0e0e0; border-radius:5px; overflow:hidden; } .progress-bar { height:100%; width:0%; background:var(--danger); transition:width 0.5s linear; }
.admin-section { padding: 12px; margin-bottom: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.admin-section h3 { font-size: 16px; margin-bottom: 12px; border-bottom: 1px solid var(--gray-200); padding-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.form-group { margin-bottom: 10px; } .form-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px; } .form-group input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
.admin-btn { width: 100%; padding: 10px; font-size: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
.schedule-management-item { display: flex; flex-direction: column; padding: 8px; border-radius: 8px; background-color: var(--gray-100); margin-bottom: 8px; gap: 6px; }
.admin-controls-row { display: flex; align-items: center; gap: 6px; width: 100%; }
.admin-emp-name-input { font-weight: 600; flex: 3 1 20px; max-width: 100px; }
.admin-emp-code-input { flex: 1 1 15px; max-width: 60px; }
.admin-controls-row input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; }
.admin-controls-row input[type="time"] { flex: 1; min-width: 65px; }
.admin-action-buttons { display: flex; gap: 6px; margin-left: auto; }
.admin-icon-btn { padding: 8px; border: none; border-radius: 6px; cursor: pointer; color: white; width: 32px; height: 32px; text-align: center; line-height: 1; font-size: 14px;}
.btn-reset-breaks { background: var(--warn); } .btn-delete-emp { background: var(--danger); }
#modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; }
#modal { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
#modal-content { font-size: 15px; margin-bottom: 20px; color: var(--gray-700); text-align: left; }
#modal-content h3, #modal-content h4 { font-size: 16px; margin-bottom: 12px; text-align: center; } 
#modal-content h4 { font-size: 14px; margin-top: 16px; border-top: 1px solid var(--gray-200); paddingTop: 12px; }
#modal-content p { margin-bottom: 10px; } #modal-content ul { list-style-type: none; padding-left: 0; } #modal-content li { background-color: var(--gray-100); padding: 8px; border-radius: 6px; margin-bottom: 5px; }
#modal-buttons { display: flex; gap: 10px; justify-content: center; }
#modal-buttons button { flex: 1; padding: 8px 16px; border-radius: 8px; border: none; font-size: 15px; cursor: pointer; font-weight: 600; }
#modal-ok { background: var(--primary); color: white; }
#modal-cancel { background: var(--gray-100); color: var(--text-dark); border: 1px solid #d1d5db; }

/* Font Size Adjustment Classes */
body.font-size-small { font-size: 12px; }
body.font-size-large { font-size: 16px; }
body.font-size-very-large { font-size: 18px; }
body.font-size-small .emp-name { font-size: 13px; }
body.font-size-large .emp-name { font-size: 15px; }
body.font-size-very-large .emp-name { font-size: 16px; }
body.font-size-small .status-item .label { font-size: 9px; }
body.font-size-large .status-item .label { font-size: 11px; }
body.font-size-very-large .status-item .label { font-size: 12px; }
body.font-size-small .status-item .value { font-size: 10px; }
body.font-size-large .status-item .value { font-size: 13px; }
body.font-size-very-large .status-item .value { font-size: 14px; }
body.font-size-small .admin-controls-row input, body.font-size-small .admin-icon-btn { font-size: 12px; }
body.font-size-large .admin-controls-row input, body.font-size-large .admin-icon-btn { font-size: 14px; }
body.font-size-very-large .admin-controls-row input, body.font-size-very-large .admin-icon-btn { font-size: 15px; }

/* Tetris Game Styles */
#tetris-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.85); z-index: 400; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; }
#tetris-container { display: flex; flex-direction: column; align-items: center; gap: 16px; }
.tetris-game-area { display: flex; align-items: flex-start; gap: 16px; }
#tetris-canvas { border: 2px solid #fff; background-color: #000; }
.tetris-info { font-size: 20px; font-weight: 600; text-align: left; }
.tetris-info div { margin-bottom: 12px; }
.tetris-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 240px; margin-top: 16px; }
.tetris-btn { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #fff; background-color: rgba(255,255,255,0.2); color: #fff; font-size: 28px; display: flex; align-items: center; justify-content: center; user-select: none; }
#tetris-rotate { grid-column: 2; }
#tetris-left { grid-column: 1; }
#tetris-right { grid-column: 3; }
#tetris-down { grid-column: 2; }
#tetris-close-btn { position: absolute; top: 15px; right: 15px; font-size: 32px; color: white; background: none; border: none; cursor: pointer; }
</style>
</head>
<body>
<div id="login-view"><div class="login-box"><h2>Đăng nhập</h2><button id="start-face-login-btn"><i class="fa-solid fa-camera"></i>&nbsp; Đăng nhập bằng Khuôn mặt</button><div id="code-login-section" style="display:none;"><p style="margin: 16px 0 8px; color: var(--gray-500); font-weight: 500;">Hoặc đăng nhập bằng mã số</p><input type="text" id="login-code-input" placeholder="Nhập mã số hoặc Admin"><button id="login-by-code-btn">Đăng nhập bằng mã</button></div><p id="login-error"></p></div></div>
<div id="app-container"><header><div class="tabs-container"><div id="tab-emp" class="tab active">Nhân viên</div><div id="tab-admin" class="tab">Quản trị</div></div><button id="font-size-btn" title="Đổi cỡ chữ"><i class="fa-solid fa-text-height"></i></button><button id="game-btn" title="Game"><i class="fa-solid fa-gamepad"></i></button><button id="logout-btn" title="Đăng xuất"><i class="fa-solid fa-right-from-bracket"></i></button></header><main><section id="view-emp"><div id="emp-list"></div></section><section id="view-admin" style="display:none"><div id="admin-content"></div></section></main></div>
<div id="modal-backdrop"><div id="modal"><div id="modal-content"></div><div id="modal-buttons"><button id="modal-cancel">Hủy</button><button id="modal-ok">OK</button></div></div></div>
<audio id="notif-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
<div id="face-modal-backdrop" style="position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; color: white;"><div id="face-modal-content" style="position: relative; background: #333; padding: 20px; border-radius: 12px; text-align: center;"><video id="video" width="300" height="225" autoplay muted playsinline style="transform: scaleX(-1);"></video><canvas id="canvas" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%);"></canvas><p id="face-modal-message" style="margin-top: 15px; font-size: 16px; min-height: 24px;">Đang tải model...</p><button id="face-modal-close" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button></div></div>
<div id="audio-container" style="display: none;">
    <audio id="audio-click" src="https://actions.google.com/sounds/v1/ui/button_press.ogg" preload="auto"></audio>
    <audio id="audio-break-toggle" src="https://actions.google.com/sounds/v1/switches/switch_on.ogg" preload="auto"></audio>
</div>

<!-- Tetris Game Modal -->
<div id="tetris-modal-backdrop">
    <button id="tetris-close-btn">&times;</button>
    <div id="tetris-container">
        <div class="tetris-game-area">
            <canvas id="tetris-canvas" width="240" height="400"></canvas>
            <div class="tetris-info">
                <div>Score: <span id="tetris-score">0</span></div>
                <div>Level: <span id="tetris-level">0</span></div>
            </div>
        </div>
        <div class="tetris-controls">
            <button class="tetris-btn" id="tetris-left"><i class="fa-solid fa-arrow-left"></i></button>
            <button class="tetris-btn" id="tetris-rotate"><i class="fa-solid fa-rotate-right"></i></button>
            <button class="tetris-btn" id="tetris-right"><i class="fa-solid fa-arrow-right"></i></button>
            <button class="tetris-btn" id="tetris-down" style="grid-column: 1 / 4;"><i class="fa-solid fa-arrow-down"></i></button>
        </div>
    </div>
</div>


<script>
// ===== Firebase Config & App State =====
const firebaseConfig = {
  apiKey: "AIzaSyCN3cJ12JkC49JJmPl1d_uJ-PFr_MhPuLs", // THAY BẰNG API KEY CỦA BẠN
  authDomain: "checkin-app-cua-toi.firebaseapp.com", // THAY BẰNG AUTH DOMAIN CỦA BẠN
  projectId: "checkin-app-cua-toi", // THAY BẰNG PROJECT ID CỦA BẠN
  storageBucket: "checkin-app-cua-toi.appspot.com", // THAY BẰNG STORAGE BUCKET CỦA BẠN
  messagingSenderId: "979758577166", // THAY BẰNG SENDER ID CỦA BẠN
  appId: "1:979758577166:web:5950cf18778a4f0c0dee5f" // THAY BẰNG APP ID CỦA BẠN
};
let db;

// Biến để lưu trữ các hàm hủy listener
let employeeListenerUnsubscribe = null;
let settingsListenerUnsubscribe = null;
let adminListenerUnsubscribe = null;
let breakLogListenerUnsubscribe = null;

const timers = {};
let AppState = { employees: [], admins: [], settings: null, breakLog: [], loggedInUserId: null, isAdmin: false };
const faceModalBackdrop = document.getElementById('face-modal-backdrop');
const faceModalMessage = document.getElementById('face-modal-message');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
let modelsLoaded = false;
let currentFaceAction = { empId: null, actionType: null, callback: null };
let faceDetectionInterval = null;
const fontSizes = ['font-size-normal', 'font-size-large', 'font-size-very-large', 'font-size-small'];

// ===== CÁC HÀM LÕI VỚI FIRESTORE =====
function setupRealtimeListeners() {
    if (!db) return;
    if (employeeListenerUnsubscribe) employeeListenerUnsubscribe();
    if (settingsListenerUnsubscribe) settingsListenerUnsubscribe();
    if (adminListenerUnsubscribe) adminListenerUnsubscribe();
    if (breakLogListenerUnsubscribe) breakLogListenerUnsubscribe();

    employeeListenerUnsubscribe = db.collection("employees").orderBy("name").onSnapshot((snapshot) => {
        let needsFullRender = false;
        snapshot.docChanges().forEach((change) => {
            const docData = change.doc.data();
            const existingEmpIndex = AppState.employees.findIndex(e => e.id === docData.id);
            if (change.type === "added" || change.type === "removed") { needsFullRender = true; }
            if (change.type === "added") { if (existingEmpIndex === -1) AppState.employees.push(docData); }
            if (change.type === "modified") { if (existingEmpIndex > -1) AppState.employees[existingEmpIndex] = docData; }
            if (change.type === "removed") { if (existingEmpIndex > -1) AppState.employees.splice(existingEmpIndex, 1); }
        });
        if (needsFullRender) { AppState.employees.sort((a, b) => a.name.localeCompare(b.name)); renderEmployees(); }
        else { snapshot.docChanges().forEach(change => { if (change.type === "modified") renderSingleEmployee(change.doc.data().id); }); }
        if (AppState.isAdmin && document.getElementById('view-admin').style.display === 'block') { renderAdminPanel(); }
    }, (error) => console.error("Lỗi khi lắng nghe `employees`: ", error));

    settingsListenerUnsubscribe = db.collection("app_state").doc("settings").onSnapshot((doc) => {
        if (doc.exists) AppState.settings = doc.data();
        if (AppState.isAdmin && document.getElementById('view-admin').style.display === 'block') renderAdminPanel();
    }, (error) => console.error("Lỗi khi lắng nghe `settings`: ", error));

    adminListenerUnsubscribe = db.collection("admins").onSnapshot((snapshot) => {
        AppState.admins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (AppState.isAdmin && document.getElementById('view-admin').style.display === 'block') renderAdminPanel();
    });

    const today = getWorkDayString(new Date());
    breakLogListenerUnsubscribe = db.collection("break_log").where("logDate", "==", today).orderBy("timestamp", "desc").onSnapshot((snapshot) => {
        AppState.breakLog = snapshot.docs.map(doc => doc.data());
    });
}


// ===== CÁC HÀM CẬP NHẬT DỮ LIỆU =====
async function updateEmployee(empId, dataToUpdate) { try { await db.collection("employees").doc(empId).update(dataToUpdate); } catch (error) { console.error(`Lỗi cập nhật ${empId}:`, error); alert("Có lỗi xảy ra."); } }
async function createEmployee(empData) { try { await db.collection("employees").doc(empData.id).set(empData); return true; } catch (error) { console.error("Lỗi thêm nhân viên:", error); return false; } }
async function removeEmployee(empId) { try { await db.collection("employees").doc(empId).delete(); return true; } catch (error) { console.error("Lỗi xóa nhân viên:", error); return false; } }
async function updateSettings(settingsData) { try { await db.collection("app_state").doc("settings").set(settingsData, { merge: true }); return true; } catch (error) { console.error("Lỗi cập nhật cài đặt:", error); return false; } }
async function updateAdmin(adminId, adminData) { try { await db.collection("admins").doc(adminId).set(adminData, { merge: true }); return true; } catch (error) { console.error("Lỗi cập nhật admin:", error); return false; } }
async function addBreakLog(logEntry) { try { await db.collection("break_log").add(logEntry); } catch (error) { console.error("Lỗi ghi log nghỉ:", error); } }
function getTimes(empId) { const emp = AppState.employees.find(e => e.id === empId); return emp?.times || { scheduledTime: null, lastCheckInDay: null, checkInTime: null, onBreak: false, breakStartTime: null, breakIndex: 0, breakHistory: [] }; }
function getBreakDurations() { return AppState.settings?.breakDurations || [10, 40, 10, 10]; }

// ===== CÁC HÀM LOGIC CỦA ỨNG DỤNG =====
async function addEmployee() { const name = document.getElementById('new-emp-name').value; const code = document.getElementById('new-emp-code').value; if (!name || !code) { showModal("<h3>Lỗi</h3><p>Vui lòng nhập đủ Tên và Mã số.</p>"); return; } if (AppState.employees.some(e => e.code == code)) { showModal("<h3>Lỗi</h3><p>Mã số đăng nhập đã tồn tại.</p>"); return; } const id = "E" + Date.now(); const newEmployee = { id, name, code, faceDescriptor: null, times: getTimes(null), breakTimes: ['', '', '', ''] }; if (await createEmployee(newEmployee)) { showModal("<h3>Thành công</h3><p>Thêm nhân viên thành công!</p>"); document.getElementById('new-emp-name').value = ''; document.getElementById('new-emp-code').value = '';} else { showModal("<h3>Lỗi</h3><p>Không thể thêm nhân viên. Vui lòng thử lại.</p>"); } }
async function deleteEmployee(empId) { const emp = AppState.employees.find(e => e.id === empId); if (!emp) return; showModal(`<h3>Xác nhận Xóa</h3><p>Bạn có chắc muốn xóa nhân viên <strong>${emp.name}</strong>?</p>`, async () => { if (await removeEmployee(empId)) showModal(`<h3>Thành công</h3><p>Đã xóa nhân viên ${emp.name}.</p>`); }, true); }
function saveSchedule(empId) { const input = document.getElementById(`schedule-${empId}`); updateEmployee(empId, { 'times.scheduledTime': input.value || null }); }
function resetBreaks(empId) { showModal(`<h3>Xác nhận</h3><p>Reset số lần nghỉ của nhân viên này?</p>`, () => { updateEmployee(empId, { 'times.breakIndex': 0, 'times.breakHistory': [], 'times.onBreak': false, 'times.breakStartTime': null }); }, true); }

function startBreak(empId) { playSound('audio-break-toggle'); const coreAction = () => { const times = getTimes(empId); const idx = times.breakIndex || 0; const breakDurations = getBreakDurations(); if (idx >= breakDurations.length) { showModal('<h3>Thông báo</h3><p>Đã hết số lần nghỉ giải lao trong ngày.</p>'); return; } showModal(`<h3>Xác nhận</h3><p>Bắt đầu nghỉ lần ${idx + 1}: ${breakDurations[idx]} phút?</p>`, () => { updateEmployee(empId, { 'times.onBreak': true, 'times.breakStartTime': new Date().toISOString(), 'times.breakIndex': idx + 1 }); }, true); }; performActionWithLocationCheck(() => openFaceModalForVerification(empId, coreAction, () => promptForCodeVerification(empId, coreAction))); }
function stopBreak(empId) { playSound('audio-break-toggle'); const coreAction = async () => { const emp = AppState.employees.find(e => e.id === empId); const times = getTimes(empId); if (!times.onBreak) return; const duration = Math.round((new Date() - new Date(times.breakStartTime)) / 1000); const newHistory = [...(times.breakHistory || []), { index: times.breakIndex, duration: duration }]; await updateEmployee(empId, { 'times.onBreak': false, 'times.breakHistory': newHistory }); addBreakLog({ empId, empName: emp.name, breakIndex: times.breakIndex, duration, timestamp: new Date().toISOString(), logDate: getWorkDayString(new Date()) }); }; performActionWithLocationCheck(() => openFaceModalForVerification(empId, coreAction, () => promptForCodeVerification(empId, coreAction))); }
async function autoStopBreak(empId) { const emp = AppState.employees.find(e => e.id === empId); const times = getTimes(empId); if (!emp || !times || !times.onBreak) return; const duration = Math.round((new Date() - new Date(times.breakStartTime)) / 1000); const newHistory = [...(times.breakHistory || []), { index: times.breakIndex, duration: duration }]; await updateEmployee(empId, { 'times.onBreak': false, 'times.breakHistory': newHistory }); addBreakLog({ empId, empName: emp.name, breakIndex: times.breakIndex, duration, timestamp: new Date().toISOString(), logDate: getWorkDayString(new Date()) }); }
async function updateEmployeeInfo(empId, field, value) { const trimmedValue = value.trim(); if (!trimmedValue) { showModal("<h3>Lỗi</h3><p>Tên và Mã số không được để trống.</p>"); renderAdminPanel(); return; } if (field === 'code' && AppState.employees.some(e => e.code === trimmedValue && e.id !== empId)) { showModal("<h3>Lỗi</h3><p>Mã số này đã được sử dụng.</p>"); renderAdminPanel(); return; } await updateEmployee(empId, { [field]: trimmedValue }); }
function updateBreakTimes(empId) { const breakTimes = Array.from({ length: 4 }, (_, i) => document.getElementById(`break${i + 1}-${emp.id}`).value || ''); updateEmployee(empId, { breakTimes }); }

function checkSchedules() { if (!AppState.employees || AppState.employees.length === 0 || !AppState.loggedInUserId) return; const now = new Date(); const currentWorkDayString = getWorkDayString(now); const batch = db.batch(); let batchHasWrites = false; AppState.employees.forEach(emp => { let times = getTimes(emp.id); if (times.lastCheckInDay && times.lastCheckInDay !== currentWorkDayString) { const newTimes = { scheduledTime: times.scheduledTime, lastCheckInDay: null, checkInTime: null, onBreak: false, breakStartTime: null, breakIndex: 0, breakHistory: [] }; batch.update(db.collection("employees").doc(emp.id), { times: newTimes }); batchHasWrites = true; } else if (times.scheduledTime && !times.checkInTime) { const scheduledDateTime = new Date(`${currentWorkDayString}T${times.scheduledTime}`); if (now >= scheduledDateTime) { const checkInData = { 'times.checkInTime': new Date().toISOString(), 'times.lastCheckInDay': currentWorkDayString }; batch.update(db.collection("employees").doc(emp.id), checkInData); batchHasWrites = true; if (AppState.loggedInUserId === emp.id) { showBrowserNotification(`${emp.name}, đến giờ làm việc!`, `Hệ thống đã tự động check-in.`); } } } }); if (batchHasWrites) { batch.commit().catch(error => console.error("Lỗi khi thực hiện batch update: ", error)); } }
function createCalendarEvents(empId) { const emp = AppState.employees.find(e => e.id === empId); if (!emp || !emp.breakTimes || emp.breakTimes.every(t => !t)) { showModal("<h3>Thông báo</h3><p>Chưa có lịch nghỉ cố định nào được thiết lập.</p>"); return; } showModal(`<h3>Xác nhận</h3><p>Thêm lịch nghỉ hôm nay vào Lịch của điện thoại?</p>`, () => { const today = new Date().toISOString().slice(0, 10); const formatICSDate = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'; let icsContent = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//Check-in App//EN']; emp.breakTimes.forEach((breakTime, index) => { if (!breakTime) return; const breakDuration = getBreakDurations()[index] || 10; const startDate = new Date(`${today}T${breakTime}`); const endDate = new Date(startDate.getTime() + breakDuration * 60000); icsContent.push('BEGIN:VEVENT', `UID:${emp.id}-break${index + 1}-${today}@checkin.app`, `DTSTAMP:${formatICSDate(new Date())}`, `DTSTART:${formatICSDate(startDate)}`, `DTEND:${formatICSDate(endDate)}`, `SUMMARY:Giờ nghỉ lần ${index + 1} (${emp.name})`, 'BEGIN:VALARM', 'ACTION:DISPLAY', 'DESCRIPTION:Đến giờ nghỉ giải lao!', 'TRIGGER:-PT0M', 'END:VALARM', 'END:VEVENT'); }); icsContent.push('END:VCALENDAR'); const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `LichNghi_${today}.ics`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); }, true); }

// ===== RENDER FUNCTIONS =====
function activateTimers() { if (!AppState.employees) return; AppState.employees.forEach(emp => { const times = getTimes(emp.id); if (times.onBreak && !timers[emp.id]) { startBreakCountdown(emp.id); } else if (!times.onBreak && timers[emp.id]) { clearInterval(timers[emp.id]); delete timers[emp.id]; } }); }
function generateEmployeeCardHTML(emp) {
    const times = getTimes(emp.id);
    const isCheckedIn = !!times.checkInTime;
    const isOnBreak = times.onBreak;
    const now = new Date();
    const currentHour = now.getHours();
    const isOutsideWorkingHours = currentHour >= 6 && currentHour < 17;

    let statusHtml = '';
    if (isOnBreak) {
        statusHtml = `<div class="status-badge status-on-break"><i class="fa-solid fa-mug-hot"></i> Đang nghỉ</div>`;
    } else if (isOutsideWorkingHours) {
        statusHtml = `<div class="status-badge status-pending">Ngoài giờ làm</div>`;
    } else if (isCheckedIn) {
        statusHtml = `<div class="status-badge status-working"><i class="fa-solid fa-person-running"></i> Đang làm</div>`;
    } else if (times.scheduledTime) {
        statusHtml = `<div class="status-badge status-scheduled">Đã lên lịch</div>`;
    } else {
        statusHtml = `<div class="status-badge status-pending">Chưa có lịch</div>`;
    }

    let actionButtonsHtml = '';
    if (emp.id === AppState.loggedInUserId && !AppState.isAdmin) {
        const hasFixedBreaks = emp.breakTimes && emp.breakTimes.some(t => t);
        const alarmBtn = hasFixedBreaks ? `<button class="btn btn-alarm" onclick="createCalendarEvents('${emp.id}')" title="Tạo báo thức lịch nghỉ"><i class="fa-solid fa-bell"></i></button>` : '';
        
        let mainBtn = '';
        if (isOnBreak) {
            mainBtn = `<button class="btn btn-stop-break" onclick="stopBreak('${emp.id}')"><i class="fa-solid fa-stop"></i> Dừng</button>`;
        } else if (isCheckedIn) { // Only show break button if checked in
            mainBtn = `<button class="btn btn-start-break" onclick="startBreak('${emp.id}')"><i class="fa-solid fa-mug-hot"></i> Nghỉ</button>`;
        }
        
        actionButtonsHtml = `<div class="action-buttons">${alarmBtn}${mainBtn}</div>`;
    }
    
    let breakTimerHtml = (isOnBreak) ? `<div class="timer-container" id="timer-container-${emp.id}" style="display: block;"><div class="timer-display"><span class="timer-text"></span><div class="progress-container"><div class="progress-bar"></div></div></div></div>` : '';
    
    const breakDurations = getBreakDurations();
    const totalBreakSeconds = (times.breakHistory || []).reduce((sum, item) => sum + item.duration, 0);

    return `<div class="card" data-emp-id="${emp.id}">
                <div class="card-header">
                    <div class="emp-info">
                        <div class="emp-name">${emp.name}</div>
                    </div>
                    <div class="header-actions">
                        ${actionButtonsHtml}
                        ${statusHtml}
                    </div>
                </div>
                <div class="card-body">
                    <div class="status-section">
                        <div class="status-item status-item-start">
                            <span class="value">${formatTo12Hour(times.scheduledTime)}</span>
                        </div>
                        <div class="status-item status-item-break-count clickable" onclick="viewBreakStatsAdmin('${emp.id}')">
                             <span class="label">Lần nghỉ:</span>
                             <span class="value break-count-value">${times.breakIndex || 0}</span><span class="value">/</span><span class="value break-total-value">${breakDurations.length}</span>
                        </div>
                        <div class="status-item status-item-total-break">
                             <span class="label">Tổng TG:</span>
                             <span class="value">${formatSeconds(totalBreakSeconds).replace(' giây', 's').replace(' phút', 'm')}</span>
                        </div>
                        <div class="status-item status-item-break-type">
                             <span class="label">Nghỉ:</span>
                             <span class="value">${isOnBreak ? `Lần ${times.breakIndex}` : '--'}</span>
                        </div>
                    </div>
                </div>
                <div class="break-visualizer">
                    ${breakTimerHtml}
                </div>
            </div>`;
}
function renderSingleEmployee(empId) { const emp = AppState.employees.find(e => e.id === empId); if (!emp) return; const empCard = document.querySelector(`.card[data-emp-id="${empId}"]`); if (empCard) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = generateEmployeeCardHTML(emp); const newCard = tempDiv.firstChild; empCard.parentNode.replaceChild(newCard, empCard); } activateTimers(); }
function renderEmployees() { const empListEl = document.getElementById('emp-list'); if (!empListEl || !AppState.employees) return; empListEl.innerHTML = AppState.employees.map(emp => generateEmployeeCardHTML(emp)).join(''); activateTimers(); }

function renderAdminPanel() {
    const adminContentEl = document.getElementById('admin-content'); if (!adminContentEl) return;
    const adminIds = ['ADMIN1', 'ADMIN2', 'ADMIN3'];
    
    let scheduleHtml = `<div class="admin-section"><h3><i class="fa-solid fa-clock"></i> Quản lý Nhân viên</h3>`;
    if (AppState.employees && AppState.employees.length > 0) {
        scheduleHtml += [...AppState.employees].sort((a, b) => a.name.localeCompare(b.name)).map(emp => {
            const faceRegistered = emp.faceDescriptor && Array.isArray(emp.faceDescriptor) && emp.faceDescriptor.length > 0;
            const breakTimes = emp.breakTimes || ['', '', '', ''];
            const breakInputsString = Array.from({length: 4}, (_, i) => `<input type="time" id="break${i+1}-${emp.id}" value="${breakTimes[i] || ''}" onblur="updateBreakTimes('${emp.id}')" title="Giờ nghỉ lần ${i+1}">`).join('');

            return `<div class="schedule-management-item">
                        <div class="admin-controls-row">
                            <input type="text" class="admin-emp-name-input" value="${emp.name}" onblur="updateEmployeeInfo('${emp.id}', 'name', this.value)" placeholder="Tên">
                            <input type="text" class="admin-emp-code-input" value="${emp.code}" onblur="updateEmployeeInfo('${emp.id}', 'code', this.value)" placeholder="Mã số">
                            <div class="admin-action-buttons">
                                <button class="admin-icon-btn" style="background-color: ${faceRegistered ? 'var(--ok)' : 'var(--primary)'};" onclick="openFaceModalForRegistration('${emp.id}')" title="Đăng ký khuôn mặt qua Camera"><i class="fa-solid ${faceRegistered ? 'fa-user-check' : 'fa-camera'}"></i></button>
                                <button class="admin-icon-btn btn-reset-breaks" onclick="resetBreaks('${emp.id}')" title="Reset nghỉ"><i class="fa-solid fa-rotate-left"></i></button>
                                <button class="admin-icon-btn btn-delete-emp" onclick="deleteEmployee('${emp.id}')" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="admin-controls-row">
                            <input type="time" id="schedule-${emp.id}" value="${getTimes(emp.id).scheduledTime || ''}" onchange="saveSchedule('${emp.id}')" title="Giờ start ca">
                            ${breakInputsString}
                        </div>
                    </div>`;
        }).join('');
    } else { 
        scheduleHtml += '<p>Chưa có nhân viên nào.</p>'; 
    }
    scheduleHtml += `</div>`;
    
    let adminManagementHtml = `<div class="admin-section"><h3><i class="fa-solid fa-user-shield"></i> Quản lý Admin</h3>`;
    adminManagementHtml += adminIds.map((adminId, index) => {
        const adminData = AppState.admins.find(a => a.id === adminId);
        const adminFaceRegistered = adminData?.faceDescriptor && adminData.faceDescriptor.length > 0;
        return `<div class="schedule-management-item">
             <div class="admin-controls-row">
                <span style="font-weight: 600; flex-grow:1;">Tài khoản Admin ${index + 1}</span>
                <div class="admin-action-buttons">
                    <button class="admin-icon-btn" style="background-color: ${adminFaceRegistered ? 'var(--ok)' : 'var(--primary)'};" onclick="openFaceModalForRegistration('${adminId}')" title="Đăng ký khuôn mặt qua Camera"><i class="fa-solid ${adminFaceRegistered ? 'fa-user-check' : 'fa-camera'}"></i></button>
                </div>
            </div>
        </div>`;
    }).join('');
    adminManagementHtml += `</div>`;
    
    let addEmployeeHtml = `<div class="admin-section"><h3><i class="fa-solid fa-user-plus"></i> Thêm nhân viên mới</h3><div class="form-group"><label>Tên nhân viên</label><input type="text" id="new-emp-name"></div><div class="form-group"><label>Mã số đăng nhập</label><input type="text" inputmode="numeric" id="new-emp-code"></div><button class="admin-btn" onclick="addEmployee()">Thêm nhân viên</button></div>`;
    
    let locationSettingsHtml = `<div class="admin-section"><h3><i class="fa-solid fa-map-marker-alt"></i> Cài đặt Vị trí & Thời gian nghỉ</h3><div class="form-group"><label>Vĩ độ</label><input type="number" step="any" id="setting-lat"></div><div class="form-group"><label>Kinh độ</label><input type="number" step="any" id="setting-lon"></div><div class="form-group"><label>Bán kính (mét)</label><input type="number" id="setting-radius"></div><button class="admin-btn" onclick="saveLocationSettingsAction()">Lưu Cài đặt</button></div>`;
    
    adminContentEl.innerHTML = scheduleHtml + adminManagementHtml + addEmployeeHtml + locationSettingsHtml;
    
    const settings = AppState.settings?.locationSettings; if (settings) { document.getElementById('setting-lat').value = settings.lat || ''; document.getElementById('setting-lon').value = settings.lon || ''; document.getElementById('setting-radius').value = settings.radius || 30; }
}
function startBreakCountdown(empId){ if (timers[empId]) clearInterval(timers[empId]); const tick = () => { const times = getTimes(empId); if (!times.onBreak) { clearInterval(timers[empId]); delete timers[empId]; return; } const timerContainerEl = document.getElementById(`timer-container-${empId}`); if (!timerContainerEl) { clearInterval(timers[empId]); delete timers[empId]; return; } const timerEl = timerContainerEl.querySelector('.timer-text'); const progressEl = timerContainerEl.querySelector('.progress-bar'); const breakDurationSeconds = (getBreakDurations()[times.breakIndex - 1] || 10) * 60; const elapsed = (new Date() - new Date(times.breakStartTime)) / 1000; const remaining = breakDurationSeconds - elapsed; if (remaining <= 0) { clearInterval(timers[empId]); delete timers[empId]; const emp = AppState.employees.find(e => e.id === empId); if(emp) { showBrowserNotification(`${emp.name}, hết giờ nghỉ!`, 'Đã hết giờ giải lao.'); if (AppState.loggedInUserId === emp.id || AppState.isAdmin) { playSound('notif-sound'); } } autoStopBreak(empId); return; } const m = String(Math.floor(remaining/60)).padStart(2,'0'); const s = String(Math.round(remaining%60)).padStart(2,'0'); if (timerEl) timerEl.textContent = `Còn lại: ${m}:${s}`; if (progressEl) progressEl.style.width = (elapsed / breakDurationSeconds) * 100 + '%'; }; timers[empId] = setInterval(tick, 1000); tick(); }
function viewBreakStatsAdmin(empId) {
    const emp = AppState.employees.find(e => e.id === empId); if(!emp) return;
    const times = getTimes(empId);
    const totalBreakSeconds = (times.breakHistory || []).reduce((sum, item) => sum + item.duration, 0);
    
    let rulesHtml = `<h4>Quy định nghỉ</h4><ul>`;
    getBreakDurations().forEach((duration, index) => {
        rulesHtml += `<li>Lần ${index + 1}: <strong>${duration} phút</strong></li>`;
    });
    rulesHtml += `</ul>`;

    let historyHtml = `<h4>Lịch sử nghỉ trong ngày</h4>`;
    if (!times.breakHistory || times.breakHistory.length === 0) {
        historyHtml += `<p>Chưa có dữ liệu nghỉ trong ngày.</p>`;
    } else {
        historyHtml += "<ul>";
        times.breakHistory.forEach(item => {
            historyHtml += `<li>Lần ${item.index}: <strong>${formatSeconds(item.duration)}</strong></li>`;
        });
        historyHtml += "</ul>";
    }

    let contentHtml = `<h3>Thống kê nghỉ - ${emp.name}</h3>
                       <p><strong>Tổng thời gian đã nghỉ:</strong> ${formatSeconds(totalBreakSeconds)}</p>
                       ${rulesHtml}
                       ${historyHtml}`;
    
    showModal(contentHtml);
}


// ===== CÁC HÀM TIỆN ÍCH & KHỞI TẠO =====
function formatTo12Hour(timeString) {
    if (!timeString || !timeString.includes(':')) return '--';
    let [hours, minutes] = timeString.split(':');
    let h = parseInt(hours, 10);
    const ampm = h >= 12 ? 'pm' : 'am';
    h = h % 12;
    h = h ? h : 12; // the hour '0' should be '12'
    return `${String(h).padStart(2, '0')}:${minutes}${ampm}`;
}
function unlockAudioContext() { const sound = document.getElementById('notif-sound'); if (sound && sound.paused) { sound.play().catch(()=>{}); sound.pause(); sound.currentTime = 0; } }
function loginWithId(userId) { unlockAudioContext(); AppState.isAdmin = userId.startsWith('ADMIN'); AppState.loggedInUserId = userId; sessionStorage.setItem('loggedInUserId', userId); document.getElementById('login-view').style.display = 'none'; document.getElementById('app-container').style.display = 'block'; updateUIVisibility(); setupRealtimeListeners(); renderEmployees(); }
function loginWithCode() { const code = document.getElementById('login-code-input').value; const errorEl = document.getElementById('login-error'); if (!code) { errorEl.textContent = 'Vui lòng nhập mã số.'; return; } if (code.toUpperCase() === 'ADMIN') { loginWithId('ADMIN1'); } else { const employee = AppState.employees.find(e => e.code == code); if (employee) { loginWithId(employee.id); } else { errorEl.textContent = 'Mã số không hợp lệ.'; } } }
async function logout() { if (employeeListenerUnsubscribe) employeeListenerUnsubscribe(); if (settingsListenerUnsubscribe) settingsListenerUnsubscribe(); if(adminListenerUnsubscribe) adminListenerUnsubscribe(); if(breakLogListenerUnsubscribe) breakLogListenerUnsubscribe(); AppState.loggedInUserId = null; AppState.isAdmin = false; AppState.employees = []; AppState.admins = []; AppState.settings = null; AppState.breakLog = []; sessionStorage.removeItem('loggedInUserId'); document.getElementById('app-container').style.display = 'none'; document.getElementById('login-view').style.display = 'flex'; document.getElementById('login-code-input').value = ''; document.getElementById('login-error').textContent = ''; document.getElementById('code-login-section').style.display = 'none'; document.getElementById('emp-list').innerHTML = ''; updateUIVisibility(); await loadInitialData(); }
function updateUIVisibility() { const adminTab = document.getElementById('tab-admin'); const empTab = document.getElementById('tab-emp'); if (AppState.isAdmin) { adminTab.style.display = 'block'; } else { adminTab.style.display = 'none'; document.getElementById('view-emp').style.display='block'; document.getElementById('view-admin').style.display='none'; empTab.classList.add('active'); adminTab.classList.remove('active'); } }
const modalBackdrop = document.getElementById('modal-backdrop'); const modalContent = document.getElementById('modal-content'); const modalOk = document.getElementById('modal-ok'); const modalCancel = document.getElementById('modal-cancel'); let onModalOkCallback = null;
function showModal(htmlContent, onOk, showCancelButton = false) { modalContent.innerHTML = htmlContent; onModalOkCallback = onOk; if (showCancelButton) { modalCancel.style.display = 'inline-block'; modalOk.textContent = 'OK'; } else { modalCancel.style.display = 'none'; modalOk.textContent = 'Đóng'; } modalBackdrop.style.display = 'flex'; }
modalOk.onclick = () => { modalBackdrop.style.display = 'none'; if (typeof onModalOkCallback === 'function') onModalOkCallback(); };
modalCancel.onclick = () => { modalBackdrop.style.display = 'none'; };
function formatSeconds(seconds) { if (seconds < 60) return `${Math.round(seconds)} giây`; const minutes = Math.floor(seconds / 60); return `${minutes} phút ${Math.round(seconds % 60)} giây`; }
function getWorkDayString(date) { const workDate = new Date(date); if (workDate.getHours() < 6) { workDate.setDate(workDate.getDate() - 1); } return workDate.toISOString().slice(0, 10); }
async function loadFaceModels() { if (modelsLoaded) return; faceModalMessage.textContent = 'Đang tải model...'; const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'; await Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL), faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL), faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL) ]); modelsLoaded = true; }
async function startVideo() { try { const stream = await navigator.mediaDevices.getUserMedia({ video: {} }); video.srcObject = stream; return new Promise(resolve => { video.onloadedmetadata = () => resolve(video); }); } catch (err) { console.error("Camera Error:", err); return null; } }
function stopVideoAndCloseModal() { const stream = video.srcObject; if (stream) { stream.getTracks().forEach(track => track.stop()); video.srcObject = null; } faceModalBackdrop.style.display = 'none'; if (faceDetectionInterval) { clearInterval(faceDetectionInterval); faceDetectionInterval = null; } }
function showCodeLogin() { document.getElementById('code-login-section').style.display = 'block'; }
document.getElementById('face-modal-close').onclick = () => { stopVideoAndCloseModal(); if (currentFaceAction.actionType === 'login') showCodeLogin(); else if (currentFaceAction.actionType === 'verify') promptForCodeVerification(currentFaceAction.empId, currentFaceAction.callback); };
async function openFaceModalForVerification(empId, onSuccess, onFailure) { currentFaceAction = { actionType: 'verify', empId: empId, callback: onSuccess }; faceModalBackdrop.style.display = 'flex'; if (!modelsLoaded) await loadFaceModels(); const emp = AppState.employees.find(e => e.id === empId); const faceDescriptor = emp?.faceDescriptor; if (!faceDescriptor || !Array.isArray(faceDescriptor) || faceDescriptor.length === 0) { stopVideoAndCloseModal(); showModal("<h3>Lỗi</h3><p>Nhân viên này chưa đăng ký khuôn mặt.</p>"); onFailure(); return; } faceModalMessage.textContent = 'Đang khởi tạo camera...'; const videoEl = await startVideo(); if (!videoEl) { stopVideoAndCloseModal(); onFailure(); return; } faceModalMessage.textContent = 'Đưa khuôn mặt vào khung hình...'; const storedDescriptor = new Float32Array(faceDescriptor); const timeout = setTimeout(() => { stopVideoAndCloseModal(); onFailure(); }, 10000); faceDetectionInterval = setInterval(async () => { const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor(); if (detection) { const distance = faceapi.euclideanDistance(detection.descriptor, storedDescriptor); if (distance < 0.5) { clearTimeout(timeout); stopVideoAndCloseModal(); onSuccess(); } else { faceModalMessage.textContent = 'Không khớp. Thử lại!'; } } }, 300); }
function promptForCodeVerification(empId, onVerified) { const emp = AppState.employees.find(e => e.id === empId); if (!emp) return; const modalContentHtml = `<h3>Xác thực bằng Mã số</h3><p>Nhập mã số của <strong>${emp.name}</strong> để tiếp tục.</p><div class="form-group"><input type="text" id="verification-code-input" inputmode="numeric" placeholder="Nhập mã số" style="text-align:center; font-size: 18px;"></div>`; showModal(modalContentHtml, () => { const enteredCode = document.getElementById('verification-code-input').value; if (emp.code === enteredCode) onVerified(); else showModal("<h3>Lỗi</h3><p>Mã số không chính xác.</p>"); }, true); }
async function loginWithFace() { currentFaceAction = { actionType: 'login' }; faceModalBackdrop.style.display = 'flex'; if (!modelsLoaded) await loadFaceModels(); const labeledDescriptors = []; const validEmployees = AppState.employees.filter(emp => emp.faceDescriptor && Array.isArray(emp.faceDescriptor) && emp.faceDescriptor.length > 0); validEmployees.forEach(emp => labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(emp.id, [new Float32Array(emp.faceDescriptor)]))); AppState.admins.forEach(admin => { if (admin.faceDescriptor && Array.isArray(admin.faceDescriptor) && admin.faceDescriptor.length > 0) { labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(admin.id, [new Float32Array(admin.faceDescriptor)])); }}); if (labeledDescriptors.length === 0) { stopVideoAndCloseModal(); showModal("<h3>Thông báo</h3><p>Chưa có ai đăng ký khuôn mặt.</p>"); showCodeLogin(); return; } const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5); faceModalMessage.textContent = 'Đang khởi tạo camera...'; const videoEl = await startVideo(); if (!videoEl) { stopVideoAndCloseModal(); showModal("<h3>Lỗi Camera</h3><p>Không thể truy cập camera.</p>"); showCodeLogin(); return; } faceModalMessage.textContent = 'Đưa khuôn mặt vào khung hình...'; const timeout = setTimeout(() => { stopVideoAndCloseModal(); showModal("<h3>Thông báo</h3><p>Không nhận diện được khuôn mặt.</p>"); showCodeLogin(); }, 15000); faceDetectionInterval = setInterval(async () => { const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor(); if (detection) { const bestMatch = faceMatcher.findBestMatch(detection.descriptor); if (bestMatch.label !== 'unknown') { clearTimeout(timeout); stopVideoAndCloseModal(); loginWithId(bestMatch.label); } } }, 500); }
async function openFaceModalForRegistration(targetId) { currentFaceAction = { actionType: 'register', empId: targetId }; faceModalBackdrop.style.display = 'flex'; if (!modelsLoaded) await loadFaceModels(); faceModalMessage.textContent = 'Đang khởi tạo camera...'; const videoEl = await startVideo(); if (!videoEl) { stopVideoAndCloseModal(); return; } faceModalMessage.textContent = 'Giữ yên khuôn mặt trong khung hình...'; let registrationDescriptor = null; let stableCounter = 0; faceDetectionInterval = setInterval(async () => { const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor(); if (detection) { if (!registrationDescriptor) registrationDescriptor = detection.descriptor; const distance = faceapi.euclideanDistance(detection.descriptor, registrationDescriptor); if (distance < 0.1) { stableCounter++; faceModalMessage.textContent = `Giữ yên... ${stableCounter}/5`; if (stableCounter >= 5) { stopVideoAndCloseModal(); const descriptorArray = Array.from(registrationDescriptor); if (targetId.startsWith('ADMIN')) { await updateAdmin(targetId, { faceDescriptor: descriptorArray }); showModal(`<h3>Thành công</h3><p>Đã đăng ký khuôn mặt cho ${targetId}.</p>`); } else { await updateEmployee(targetId, { faceDescriptor: descriptorArray }); const emp = AppState.employees.find(e => e.id === targetId); showModal(`<h3>Thành công</h3><p>Đã đăng ký khuôn mặt cho ${emp.name}.</p>`); } } } else { registrationDescriptor = detection.descriptor; stableCounter = 0; faceModalMessage.textContent = 'Khuôn mặt di chuyển...'; } } }, 400); }
async function saveLocationSettingsAction() { const lat = parseFloat(document.getElementById('setting-lat').value); const lon = parseFloat(document.getElementById('setting-lon').value); const radius = parseFloat(document.getElementById('setting-radius').value); if (isNaN(lat) || isNaN(lon) || isNaN(radius)) { showModal("<h3>Lỗi</h3><p>Vui lòng nhập thông tin vị trí hợp lệ.</p>"); return; } if(await updateSettings({ locationSettings: { lat, lon, radius } })) showModal("<h3>Thành công</h3><p>Đã lưu cài đặt vị trí.</p>"); }
function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371e3; const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180; const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180; const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; }
function performActionWithLocationCheck(actionCallback) { const settings = AppState.settings?.locationSettings; if (!settings || !settings.lat || !settings.lon || !settings.radius) { actionCallback(); return; } if (!navigator.geolocation) { showModal("<h3>Lỗi</h3><p>Trình duyệt không hỗ trợ định vị.</p>"); return; } showModal("<h3>Đang lấy vị trí...</h3>"); navigator.geolocation.getCurrentPosition( (position) => { const distance = calculateDistance(settings.lat, settings.lon, position.coords.latitude, position.coords.longitude); if (distance <= settings.radius) { modalBackdrop.style.display = 'none'; actionCallback(); } else { showModal(`<h3>Lỗi</h3><p>Bạn đang ở ngoài khu vực cho phép (${Math.round(distance)}m).</p>`); } }, () => showModal(`<h3>Lỗi</h3><p>Không thể lấy được vị trí của bạn.</p>`), { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } ); }
async function requestNotificationPermission() { if ('Notification' in window) await Notification.requestPermission(); }
function showBrowserNotification(title, body) { if ('Notification'in window && Notification.permission === 'granted') new Notification(title, { body: body }); }
document.getElementById('tab-emp').onclick = ()=>{ document.getElementById('view-emp').style.display='block'; document.getElementById('view-admin').style.display='none'; document.getElementById('tab-emp').classList.add('active'); document.getElementById('tab-admin').classList.remove('active'); };
document.getElementById('tab-admin').onclick = ()=>{ document.getElementById('view-emp').style.display='none'; document.getElementById('view-admin').style.display='block'; document.getElementById('tab-admin').classList.add('active'); document.getElementById('tab-emp').classList.remove('active'); renderAdminPanel(); };
document.getElementById('start-face-login-btn').onclick = loginWithFace;
document.getElementById('login-by-code-btn').onclick = loginWithCode;
document.getElementById('logout-btn').onclick = logout;
document.getElementById('font-size-btn').onclick = () => {
    const currentSize = fontSizes.find(size => document.body.classList.contains(size)) || fontSizes[0];
    const currentIndex = fontSizes.indexOf(currentSize);
    const nextIndex = (currentIndex + 1) % fontSizes.length;
    const newSize = fontSizes[nextIndex];
    
    fontSizes.forEach(size => document.body.classList.remove(size));
    if (newSize !== 'font-size-normal') {
       document.body.classList.add(newSize);
    }
    localStorage.setItem('appFontSize', newSize);
    playSound('audio-click');
};
document.getElementById('login-code-input').addEventListener('keyup', (event) => { if (event.key === 'Enter') loginWithCode(); });
function playSound(soundId) { const audioElement = document.getElementById(soundId); if (audioElement) { audioElement.currentTime = 0; audioElement.play().catch(error => { console.warn(`Âm thanh '${soundId}' không thể phát tự động:`, error); }); } }
document.body.addEventListener('click', (event) => { const target = event.target.closest('button, .btn, .clickable, .tab'); if (!target) return; if (target.classList.contains('btn-start-break') || target.classList.contains('btn-stop-break')) { return; } playSound('audio-click'); });

async function loadInitialData() {
    try {
        const [empSnapshot, settingsDoc, adminSnapshot] = await Promise.all([
            db.collection('employees').get(),
            db.collection('app_state').doc('settings').get(),
            db.collection('admins').get()
        ]);
        AppState.employees = empSnapshot.docs.map(doc => doc.data());
        if (settingsDoc.exists) AppState.settings = settingsDoc.data();
        AppState.admins = adminSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
        console.error("Lỗi khi tải dữ liệu ban đầu:", error);
        alert("Không thể tải dữ liệu từ máy chủ. Vui lòng kiểm tra kết nối mạng.");
    }
}
function checkExpiredBreaks() {
    if (!AppState.employees || !AppState.loggedInUserId) return;
    AppState.employees.forEach(emp => {
        const times = getTimes(emp.id);
        if (times.onBreak) {
            const breakDurationSeconds = (getBreakDurations()[times.breakIndex - 1] || 10) * 60;
            const elapsed = (new Date() - new Date(times.breakStartTime)) / 1000;
            if (breakDurationSeconds - elapsed <= 0) {
                if (timers[emp.id]) { clearInterval(timers[emp.id]); delete timers[emp.id]; }
                showBrowserNotification(`${emp.name}, hết giờ nghỉ!`, 'Đã hết giờ giải lao.');
                if (AppState.loggedInUserId === emp.id || AppState.isAdmin) { playSound('notif-sound'); }
                autoStopBreak(emp.id);
            }
        }
    });
}

// ===== TETRIS GAME LOGIC =====
const tetrisCanvas = document.getElementById('tetris-canvas');
const tetrisCtx = tetrisCanvas.getContext('2d');
const tetrisScoreEl = document.getElementById('tetris-score');
const tetrisLevelEl = document.getElementById('tetris-level');
const tetrisModal = document.getElementById('tetris-modal-backdrop');

tetrisCtx.scale(20, 20);

let dropCounter = 0;
let dropInterval = 1000;
let lastTime = 0;
let animationFrameId;

const arena = createMatrix(12, 20);
const player = { pos: { x: 0, y: 0 }, matrix: null, score: 0, level: 0, rows: 0 };
const colors = [ null, '#FF0D72', '#0DC2FF', '#0DFF72', '#F538FF', '#FF8E0D', '#FFE138', '#3877FF' ];

function arenaSweep() {
    let rowCount = 1;
    outer: for (let y = arena.length - 1; y > 0; --y) {
        for (let x = 0; x < arena[y].length; ++x) {
            if (arena[y][x] === 0) {
                continue outer;
            }
        }
        const row = arena.splice(y, 1)[0].fill(0);
        arena.unshift(row);
        ++y;
        player.score += rowCount * 10;
        player.rows++;
        rowCount *= 2;
        if (player.rows % 10 === 0) {
            player.level++;
            dropInterval *= 0.9;
            tetrisLevelEl.innerText = player.level;
        }
    }
}

function collide(arena, player) {
    const [m, o] = [player.matrix, player.pos];
    for (let y = 0; y < m.length; ++y) {
        for (let x = 0; x < m[y].length; ++x) {
            if (m[y][x] !== 0 && (arena[y + o.y] && arena[y + o.y][x + o.x]) !== 0) {
                return true;
            }
        }
    }
    return false;
}

function createMatrix(w, h) {
    const matrix = [];
    while (h--) {
        matrix.push(new Array(w).fill(0));
    }
    return matrix;
}

function createPiece(type) {
    if (type === 'T') { return [[0, 0, 0], [1, 1, 1], [0, 1, 0]]; }
    else if (type === 'O') { return [[2, 2], [2, 2]]; }
    else if (type === 'L') { return [[0, 3, 0], [0, 3, 0], [0, 3, 3]]; }
    else if (type === 'J') { return [[0, 4, 0], [0, 4, 0], [4, 4, 0]]; }
    else if (type === 'I') { return [[0, 5, 0, 0], [0, 5, 0, 0], [0, 5, 0, 0], [0, 5, 0, 0]]; }
    else if (type === 'S') { return [[0, 6, 6], [6, 6, 0], [0, 0, 0]]; }
    else if (type === 'Z') { return [[7, 7, 0], [0, 7, 7], [0, 0, 0]]; }
}

function drawMatrix(matrix, offset) {
    matrix.forEach((row, y) => {
        row.forEach((value, x) => {
            if (value !== 0) {
                tetrisCtx.fillStyle = colors[value];
                tetrisCtx.fillRect(x + offset.x, y + offset.y, 1, 1);
            }
        });
    });
}

function draw() {
    tetrisCtx.fillStyle = '#000';
    tetrisCtx.fillRect(0, 0, tetrisCanvas.width, tetrisCanvas.height);
    drawMatrix(arena, { x: 0, y: 0 });
    drawMatrix(player.matrix, player.pos);
}

function merge(arena, player) {
    player.matrix.forEach((row, y) => {
        row.forEach((value, x) => {
            if (value !== 0) {
                arena[y + player.pos.y][x + player.pos.x] = value;
            }
        });
    });
}

function rotate(matrix, dir) {
    for (let y = 0; y < matrix.length; ++y) {
        for (let x = 0; x < y; ++x) {
            [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
        }
    }
    if (dir > 0) { matrix.forEach(row => row.reverse()); }
    else { matrix.reverse(); }
}

function playerDrop() {
    player.pos.y++;
    if (collide(arena, player)) {
        player.pos.y--;
        merge(arena, player);
        playerReset();
        arenaSweep();
        updateScore();
    }
    dropCounter = 0;
}

function playerMove(offset) {
    player.pos.x += offset;
    if (collide(arena, player)) {
        player.pos.x -= offset;
    }
}

function playerReset() {
    const pieces = 'ILJOTSZ';
    player.matrix = createPiece(pieces[pieces.length * Math.random() | 0]);
    player.pos.y = 0;
    player.pos.x = (arena[0].length / 2 | 0) - (player.matrix[0].length / 2 | 0);
    if (collide(arena, player)) {
        arena.forEach(row => row.fill(0));
        player.score = 0;
        player.level = 0;
        player.rows = 0;
        dropInterval = 1000;
        updateScore();
    }
}

function playerRotate(dir) {
    const pos = player.pos.x;
    let offset = 1;
    rotate(player.matrix, dir);
    while (collide(arena, player)) {
        player.pos.x += offset;
        offset = -(offset + (offset > 0 ? 1 : -1));
        if (offset > player.matrix[0].length) {
            rotate(player.matrix, -dir);
            player.pos.x = pos;
            return;
        }
    }
}

function update(time = 0) {
    const deltaTime = time - lastTime;
    lastTime = time;
    dropCounter += deltaTime;
    if (dropCounter > dropInterval) {
        playerDrop();
    }
    draw();
    animationFrameId = requestAnimationFrame(update);
}

function updateScore() {
    tetrisScoreEl.innerText = player.score;
    tetrisLevelEl.innerText = player.level;
}

function startGame() {
    playerReset();
    updateScore();
    if(animationFrameId) cancelAnimationFrame(animationFrameId);
    update();
}

document.addEventListener('keydown', event => {
    if (tetrisModal.style.display !== 'flex') return;
    if (event.key === 'ArrowLeft') playerMove(-1);
    else if (event.key === 'ArrowRight') playerMove(1);
    else if (event.key === 'ArrowDown') playerDrop();
    else if (event.key === 'ArrowUp') playerRotate(1);
});

async function initializeApp() {
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch (e) { alert("Lỗi khởi tạo Firebase. Vui lòng kiểm tra lại cấu hình."); return; }
    await requestNotificationPermission();
    
    const savedFontSize = localStorage.getItem('appFontSize') || 'font-size-normal';
    if (savedFontSize !== 'font-size-normal') {
        document.body.classList.add(savedFontSize);
    }
    
    await loadInitialData();
    const loggedInId = sessionStorage.getItem('loggedInUserId');
    if (loggedInId) {
        loginWithId(loggedInId);
    }

    setInterval(checkSchedules, 5000);
    loadFaceModels();
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            checkExpiredBreaks();
        }
    });
}
if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW registration failed: ', err)); }); }
function waitForFirebase(callback) { const interval = setInterval(() => { if (typeof firebase !== 'undefined' && firebase.firestore) { clearInterval(interval); callback(); } }, 100); }
waitForFirebase(initializeApp);

// Event Listeners
document.getElementById('tab-emp').onclick = ()=>{ document.getElementById('view-emp').style.display='block'; document.getElementById('view-admin').style.display='none'; document.getElementById('tab-emp').classList.add('active'); document.getElementById('tab-admin').classList.remove('active'); };
document.getElementById('tab-admin').onclick = ()=>{ document.getElementById('view-emp').style.display='none'; document.getElementById('view-admin').style.display='block'; document.getElementById('tab-admin').classList.add('active'); document.getElementById('tab-emp').classList.remove('active'); renderAdminPanel(); };
document.getElementById('start-face-login-btn').onclick = loginWithFace;
document.getElementById('login-by-code-btn').onclick = loginWithCode;
document.getElementById('logout-btn').onclick = logout;
document.getElementById('font-size-btn').onclick = () => {
    const currentSize = fontSizes.find(size => document.body.classList.contains(size)) || fontSizes[0];
    const currentIndex = fontSizes.indexOf(currentSize);
    const nextIndex = (currentIndex + 1) % fontSizes.length;
    const newSize = fontSizes[nextIndex];
    
    fontSizes.forEach(size => document.body.classList.remove(size));
    if (newSize !== 'font-size-normal') {
       document.body.classList.add(newSize);
    }
    localStorage.setItem('appFontSize', newSize);
    playSound('audio-click');
};
document.getElementById('login-code-input').addEventListener('keyup', (event) => { if (event.key === 'Enter') loginWithCode(); });
document.getElementById('game-btn').onclick = () => {
    tetrisModal.style.display = 'flex';
    startGame();
};
document.getElementById('tetris-close-btn').onclick = () => {
    tetrisModal.style.display = 'none';
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
};
document.getElementById('tetris-left').onclick = () => playerMove(-1);
document.getElementById('tetris-right').onclick = () => playerMove(1);
document.getElementById('tetris-down').onclick = () => playerDrop();
document.getElementById('tetris-rotate').onclick = () => playerRotate(1);

function playSound(soundId) { const audioElement = document.getElementById(soundId); if (audioElement) { audioElement.currentTime = 0; audioElement.play().catch(error => { console.warn(`Âm thanh '${soundId}' không thể phát tự động:`, error); }); } }
document.body.addEventListener('click', (event) => { const target = event.target.closest('button, .btn, .clickable, .tab'); if (!target) return; if (target.classList.contains('btn-start-break') || target.classList.contains('btn-stop-break')) { return; } playSound('audio-click'); });

</script>
</body>
</html>
