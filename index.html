<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Check-in WebApp Mobile</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="manifest" href="manifest.json">

<style>
:root { 
  --primary:#2563eb; --danger:#dc2626; --ok:#16a34a; --bg:#f6f7fb; 
  --warn:#f59e0b; --gray-100:#f3f4f6; --gray-500:#6b7280; --gray-700:#374151;
  --text-light: #fff; --text-dark:#1f2937;
}
* { 
  box-sizing:border-box; margin:0; padding:0; 
  font-family:'Be Vietnam Pro', system-ui, Arial, sans-serif; 
}
body { background:var(--bg); color:var(--text-dark); }
header { 
  position:sticky; top:0; background:var(--text-light); 
  border-bottom:1px solid #e5e7eb; padding:12px; z-index:100; display:flex; gap:8px; 
}
.tab { 
  flex:1; text-align:center; padding:12px; border-radius:8px; 
  background:var(--gray-100); font-weight:600; cursor:pointer;
  transition: all 0.2s ease-in-out;
}
.tab:hover { background: #e5e7eb; }
.tab.active { background:var(--primary); color:var(--text-light); }
main { padding:12px; max-width:480px; margin:0 auto; }
.card {
  background:var(--text-light); border-radius:12px; margin-bottom:16px; 
  box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow:hidden;
}
.card-header {
  display:flex; justify-content: space-between; align-items: center; gap:12px;
  padding:12px; border-bottom:1px solid var(--gray-100);
}
.emp-info { display: flex; align-items: center; gap: 12px;}
.emp-info .icon { font-size: 20px; color: var(--primary); }
.emp-name { font-weight:700; font-size:18px; }
.emp-id { font-size:12px; color:var(--gray-500); }
.status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; color: white; }
.status-checked-in { background-color: var(--ok); }
.status-pending { background-color: var(--gray-500); }
.status-scheduled { background-color: var(--primary); }
.card-body { padding:12px; }
.status-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
    margin-bottom: 12px; font-size: 14px;
}
.status-item {
    background-color: var(--gray-100); padding: 8px;
    border-radius: 6px; text-align: center;
}
.status-item .label { font-weight: 500; color: var(--gray-500); font-size: 12px; }
.status-item .value { font-weight: 600; color: var(--text-dark); }
.btn-break { 
  width: 100%; padding:12px; border:none; border-radius:10px; 
  font-size:16px; font-weight:600; cursor:pointer;
  background:var(--warn); color:var(--text-light);
  transition: all 0.2s ease-in-out;
}
.btn-break:disabled { background-color: #d1d5db; cursor: not-allowed; }
.timer { 
  font-size:14px; color:var(--gray-700); margin-top:12px; font-weight:500; text-align:center; 
}
.progress-container { height:8px; background:#eee; border-radius:5px; margin-top:6px; overflow:hidden; }
.progress-bar { height:100%; width:0%; background:var(--warn); transition:width 0.5s linear; }

/* Giao diện Admin */
.admin-section {
    background: white; padding: 16px; border-radius: 12px;
    margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}
.admin-section h3 {
    margin-bottom: 12px; border-bottom: 1px solid var(--gray-100);
    padding-bottom: 8px; display: flex; align-items: center; gap: 8px; font-size: 18px;
}
.form-group { margin-bottom: 10px; }
.form-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px; }
.form-group input, .form-group select {
    width: 100%; padding: 10px; border-radius: 8px;
    border: 1px solid #ccc; font-size: 16px;
}
.admin-btn {
    width: 100%; padding: 12px; font-size: 16px; background: var(--primary);
    color: white; border: none; border-radius: 8px; cursor: pointer;
    font-weight: 600;
}
.current-device-info { font-size: 12px; background: #e0e7ff; padding: 8px; border-radius: 6px; color: #3730a3; margin-bottom: 12px; word-break: break-all;}
.admin-notice { font-size: 14px; color: var(--gray-700); }
.assigned-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    background-color: var(--gray-100);
    margin-bottom: 8px;
}
.assigned-info .name { font-weight: 600; font-size: 16px;}
.assigned-info .device-id { font-size: 12px; color: var(--gray-500); word-break: break-all; }
.btn-unassign-new {
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    font-size: 16px;
    line-height: 40px;
    text-align: center;
}

/* Modal */
#modal-backdrop {
    position: fixed; inset: 0; background-color: rgba(0,0,0,0.5);
    z-index: 200; display: none; align-items: center; justify-content: center;
}
#modal {
    background: white; padding: 24px; border-radius: 12px;
    width: 90%; max-width: 350px; text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
#modal-message { font-size: 16px; margin-bottom: 20px; color: var(--gray-700); }
#modal-ok {
    padding: 10px 20px; border-radius: 8px; border: none;
    background: var(--primary); color: white; font-size: 16px; cursor: pointer;
}
</style>
</head>
<body>

<header>
  <div id="tab-emp" class="tab active">Nhân viên</div>
  <div id="tab-admin" class="tab">Quản trị</div>
</header>

<main>
<section id="view-emp">
  <div id="emp-list"></div>
</section>

<section id="view-admin" style="display:none">
  <div id="admin-content"></div>
</section>
</main>

<div id="modal-backdrop"><div id="modal"><p id="modal-message"></p><button id="modal-ok">OK</button></div></div>
<audio id="notif-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
// ===== Data & State, Hàm tiện ích & Lưu trữ =====
// (Không thay đổi)
const BREAKS = [10,40,10,10];
const timers = {};
let AppState = { employees: [], registry: {}, times: {} };
function getDeviceId(){
  let id = localStorage.getItem('deviceId');
  if(!id){
    id = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now();
    localStorage.setItem('deviceId', id);
  }
  return id;
}
function loadData() {
    let employees = JSON.parse(localStorage.getItem('employees'));
    if (!employees || employees.length === 0) {
        employees = generateInitialEmployees();
        saveEmployees(employees);
    }
    AppState.employees = employees;
    AppState.registry = JSON.parse(localStorage.getItem('registry') || '{}');
    AppState.times = JSON.parse(localStorage.getItem('times') || '{}');
}
function saveEmployees(employees) {
    AppState.employees = employees;
    localStorage.setItem('employees', JSON.stringify(employees));
}
function saveRegistry() { localStorage.setItem('registry', JSON.stringify(AppState.registry)); }
function saveTimes() { localStorage.setItem('times', JSON.stringify(AppState.times)); }
function getTimes(empId) {
    return AppState.times[empId] || { 
        scheduledTime: null, lastCheckInDay: null, checkInTime: null, 
        onBreak: false, breakStartTime: null, breakIndex: 0 
    };
}
function generateInitialEmployees() {
    const names = ["An", "Bình", "Cúc", "Dũng", "Giang", "Hương", "Khanh", "Lan", "Minh", "Nam", "Oanh", "Phúc", "Quân", "Sơn", "Thảo", "Uyên", "Vân", "Xuân", "Yến", "Ánh"];
    return names.map((name, index) => ({ id: `E${index + 1}`, name: `Nguyễn Văn ${name}` }));
}
const modalBackdrop = document.getElementById('modal-backdrop');
const modalMessage = document.getElementById('modal-message');
const modalOk = document.getElementById('modal-ok');
let onModalOk = null;
function showModal(message, onOkCallback) {
    modalMessage.textContent = message; onModalOk = onOkCallback;
    modalBackdrop.style.display = 'flex';
}
modalOk.onclick = () => {
    modalBackdrop.style.display = 'none'; if (onModalOk) onModalOk();
};
function getCurrentLocation(cb){
  if(navigator.geolocation){ 
    navigator.geolocation.getCurrentPosition(
        pos => cb(pos.coords.latitude+','+pos.coords.longitude),
        () => { showModal('Không thể lấy vị trí. Vui lòng bật định vị.'); cb(null); }
    ); 
  } else { showModal('Trình duyệt không hỗ trợ định vị.'); cb(null); }
}

// ===== Chức năng Thông báo & Service Worker =====
// (Không thay đổi)
async function requestNotificationPermission() {
    if (!('Notification' in window)) {
        showModal('Trình duyệt này không hỗ trợ thông báo.');
        return false;
    }
    const permission = await Notification.requestPermission();
    if (permission === 'granted') { return true; }
    showModal('Bạn đã không cho phép nhận thông báo. Cảnh báo hết giờ nghỉ sẽ không hoạt động khi app bị đóng.');
    return false;
}
function scheduleBackgroundNotification(empName, breakMinutes) {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const endTime = Date.now() + breakMinutes * 60 * 1000;
        navigator.serviceWorker.controller.postMessage({
            type: 'SCHEDULE_BREAK_END',
            payload: { empName: empName, endTime: endTime }
        });
    }
}

// ===== Chức năng Phía Nhân viên =====
// (Không thay đổi)
async function startBreak(empId){
  if(AppState.registry[empId]?.device !== getDeviceId()){ showModal('Thiết bị không hợp lệ.'); return; }
  const times = getTimes(empId);
  const idx = times.breakIndex || 0;
  if(idx >= BREAKS.length){ showModal('Bạn đã hết số lần nghỉ giải lao trong ngày.'); return; }
  const hasPermission = await requestNotificationPermission();
  showModal(`Bắt đầu nghỉ lần ${idx+1}: ${BREAKS[idx]} phút.`, () => {
      times.onBreak = true; times.breakStartTime = new Date().toISOString();
      times.breakIndex = idx + 1;
      AppState.times[empId] = times; saveTimes();
      startBreakCountdown(empId, BREAKS[idx] * 60);
      const employee = AppState.employees.find(e => e.id === empId);
      if (hasPermission) {
          scheduleBackgroundNotification(employee.name, BREAKS[idx]);
      }
      renderEmployees();
  });
}
function startBreakCountdown(empId, totalSeconds){
  if (timers[empId]) clearInterval(timers[empId]);
  const sound = document.getElementById('notif-sound');
  function tick(){
    const timerEl = document.getElementById(`timer-${empId}`), progressEl = document.getElementById(`progress-${empId}`);
    if(!timerEl || !progressEl) { clearInterval(timers[empId]); return; }
    const times = getTimes(empId);
    const elapsed = (new Date() - new Date(times.breakStartTime)) / 1000;
    let remaining = totalSeconds - elapsed;
    if(remaining <= 0){ 
      sound.play(); clearInterval(timers[empId]);
      times.onBreak = false; AppState.times[empId] = times; saveTimes();
      renderEmployees();
      showModal(`Giờ nghỉ của ${AppState.employees.find(e=>e.id===empId).name} đã kết thúc!`);
      return;
    }
    const m = String(Math.floor(remaining/60)).padStart(2,'0'), s = String(Math.round(remaining%60)).padStart(2,'0');
    timerEl.textContent = `Đang nghỉ: ${m}:${s}`;
    progressEl.style.width = (elapsed / totalSeconds) * 100 + '%';
  }
  tick(); timers[empId] = setInterval(tick,1000);
}
function renderEmployees(){
  const empListEl = document.getElementById('emp-list');
  empListEl.innerHTML = '';
  AppState.employees.forEach(emp=>{
    const times = getTimes(emp.id);
    const card = document.createElement('div'); card.className='card';
    const isCheckedIn = !!times.checkInTime, isOnBreak = times.onBreak;
    const breakDisabled = !isCheckedIn || isOnBreak ? 'disabled' : '';
    let statusHtml = '';
    if (isCheckedIn) {
        statusHtml = `<div class="status-badge status-checked-in">Đã Check In</div>`;
    } else if (times.scheduledTime) {
        statusHtml = `<div class="status-badge status-scheduled">Đã lên lịch</div>`;
    } else {
        statusHtml = `<div class="status-badge status-pending">Chưa có lịch</div>`;
    }
    card.innerHTML=`<div class="card-header"><div class="emp-info"><i class="fa-solid fa-user icon"></i><div><div class="emp-name">${emp.name}</div><div class="emp-id">ID: ${emp.id}</div></div></div>${statusHtml}</div><div class="card-body"><div class="status-grid"><div class="status-item"><div class="label">Bắt đầu lúc</div><div class="value">${times.scheduledTime || 'Chưa đặt'}</div></div><div class="status-item"><div class="label">Lần nghỉ</div><div class="value">${times.breakIndex || 0}/${BREAKS.length}</div></div></div><div class="timer-container" style="${isOnBreak ? '' : 'display:none;'}"><div class="timer" id="timer-${empId}"></div><div class="progress-container"><div class="progress-bar" id="progress-${empId}"></div></div></div><button class="btn-break" ${breakDisabled} onclick="startBreak('${empId}')"><i class="fa-solid fa-mug-hot"></i> Bắt đầu nghỉ</button></div>`;
    empListEl.appendChild(card);
    if (isOnBreak) {
        const breakDuration = BREAKS[times.breakIndex - 1] * 60;
        startBreakCountdown(emp.id, breakDuration);
    }
  });
}

// ===== Chức năng Phía ADMIN =====

function unassignDevice(empId) {
    showModal(`Bạn có chắc muốn hủy gán thiết bị cho nhân viên ${empId}?`, () => {
        delete AppState.registry[empId];
        saveRegistry();
        showModal(`Đã hủy gán thiết bị cho ${empId}.`);
        renderAdminPanel();
    });
}

// === CẬP NHẬT HÀM ASSIGNDEVICE ĐỂ HIỂN THỊ THÔNG BÁO TỐT HƠN ===
function assignDevice() {
    const selectedEmpId = document.getElementById('assign-device-select').value;
    if (!selectedEmpId) { showModal('Vui lòng chọn một nhân viên để gán.'); return; }

    getCurrentLocation(loc => {
        if (!loc) return;
        const currentDeviceId = getDeviceId();

        for (const existingEmpId in AppState.registry) {
            if (AppState.registry[existingEmpId].device === currentDeviceId) {
                // Tìm tên nhân viên để hiển thị thông báo thân thiện hơn
                const holder = AppState.employees.find(e => e.id === existingEmpId);
                const holderName = holder ? holder.name : existingEmpId;

                showModal(`Lỗi: Thiết bị này đã được gán cho ${holderName}. Vui lòng hủy gán trước.`);
                return;
            }
        }

        AppState.registry[selectedEmpId] = { device: currentDeviceId, location: loc };
        saveRegistry();
        
        const assignedEmployee = AppState.employees.find(e => e.id === selectedEmpId);
        const assignedEmployeeName = assignedEmployee ? assignedEmployee.name : selectedEmpId;

        showModal(`Đã gán thành công thiết bị này cho nhân viên ${assignedEmployeeName}.`);
        renderAdminPanel();
    });
}

function renderAdminPanel(){
  const adminContentEl = document.getElementById('admin-content');
  const currentDeviceId = getDeviceId();
  
  const assignedEmployees = [];
  const unassignedEmployees = [];
  let currentDeviceHolder = null;

  AppState.employees.forEach(emp => {
      if (AppState.registry[emp.id]) {
          const assignedEmp = { ...emp, deviceId: AppState.registry[emp.id].device };
          assignedEmployees.push(assignedEmp);
          if (assignedEmp.deviceId === currentDeviceId) {
              currentDeviceHolder = assignedEmp;
          }
      } else {
          unassignedEmployees.push(emp);
      }
  });

  let assignedHtml = `
    <div class="admin-section">
        <h3><i class="fa-solid fa-link"></i> Thiết bị đã gán</h3>`;
  if (assignedEmployees.length > 0) {
      assignedEmployees.forEach(emp => {
          assignedHtml += `
              <div class="assigned-item">
                  <div class="assigned-info">
                      <div class="name">${emp.name} (${emp.id})</div>
                      <div class="device-id">Device: ${emp.deviceId}</div>
                  </div>
                  <button class="btn-unassign-new" onclick="unassignDevice('${emp.id}')">
                      <i class="fa-solid fa-trash"></i>
                  </button>
              </div>`;
      });
  } else {
      assignedHtml += '<p class="admin-notice">Chưa có thiết bị nào được gán.</p>';
  }
  assignedHtml += '</div>';
  
  let assignDeviceHtml = `
    <div class="admin-section">
        <h3><i class="fa-solid fa-mobile-screen-button"></i> Gán thiết bị này</h3>
        <div class="current-device-info">ID thiết bị hiện tại: ${currentDeviceId}</div>`;
    if (currentDeviceHolder) {
        assignDeviceHtml += `<p class="admin-notice">Thiết bị này đã được gán cho <strong>${currentDeviceHolder.name}</strong>. Vui lòng hủy gán ở trên trước khi gán cho người mới.</p>`;
    } else {
        if (unassignedEmployees.length > 0) {
            assignDeviceHtml += `
              <div class="form-group">
                <label for="assign-device-select">Chọn nhân viên chưa được gán</label>
                <select id="assign-device-select">
                    <option value="">-- Chọn nhân viên --</option>
                    ${unassignedEmployees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.id})</option>`).join('')}
                </select>
              </div>
              <button class="admin-btn" onclick="assignDevice()">Gán cho nhân viên đã chọn</button>`;
        } else {
            assignDeviceHtml += '<p class="admin-notice">Tất cả nhân viên đã được gán thiết bị.</p>';
        }
    }
    assignDeviceHtml += '</div>';

  adminContentEl.innerHTML = assignedHtml + assignDeviceHtml;
}

// ===== Tự động kiểm tra lịch và Check-in =====
// (Không thay đổi)
function checkSchedules() {
    const now = new Date();
    const todayString = now.toISOString().slice(0, 10);
    let needsRender = false;
    AppState.employees.forEach(emp => {
        const times = getTimes(emp.id);
        if (times.checkInTime && times.lastCheckInDay !== todayString) {
            times.checkInTime = null; times.onBreak = false;
            times.breakIndex = 0; times.breakStartTime = null;
            AppState.times[emp.id] = times; needsRender = true;
        }
        if (!times.checkInTime && times.scheduledTime) {
            const scheduledTimeToday = new Date(`${todayString}T${times.scheduledTime}`);
            if (now >= scheduledTimeToday) {
                times.checkInTime = new Date().toISOString();
                times.lastCheckInDay = todayString;
                AppState.times[emp.id] = times; needsRender = true;
            }
        }
    });
    if (needsRender) {
        saveTimes();
        renderEmployees();
    }
}

// ==== Tabs ====
// (Không thay đổi)
document.getElementById('tab-emp').onclick = ()=>{
  document.getElementById('view-emp').style.display='block';
  document.getElementById('view-admin').style.display='none';
  document.getElementById('tab-emp').classList.add('active');
  document.getElementById('tab-admin').classList.remove('active');
};
document.getElementById('tab-admin').onclick = ()=>{
  document.getElementById('view-emp').style.display='none';
  document.getElementById('view-admin').style.display='block';
  document.getElementById('tab-admin').classList.add('active');
  document.getElementById('tab-emp').classList.remove('active');
  renderAdminPanel();
};

// ==== Init ====
// (Không thay đổi)
async function initializeApp() {
    if ('serviceWorker' in navigator) {
        try {
            await navigator.serviceWorker.register('service-worker.js');
            console.log('Service Worker registered successfully.');
        } catch (error) {
            console.error('Service Worker registration failed:', error);
        }
    }
    loadData();
    renderEmployees();
    checkSchedules(); 
    setInterval(checkSchedules, 5000);
}
initializeApp();

</script>

</body>
</html>
