<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Check-in WebApp Mobile</title>
<style>
:root { --primary:#2563eb; --danger:#dc2626; --ok:#16a34a; --bg:#f6f7fb; --warn:#facc15;}
* { box-sizing:border-box; margin:0; padding:0; font-family:system-ui, Arial, sans-serif; }
body { background:var(--bg); color:#111; }
header { position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; padding:12px; z-index:100; display:flex; gap:4px; }
.tab { flex:1; text-align:center; padding:12px; border-radius:8px; background:#f3f4f6; font-weight:600; }
.tab.active { background:var(--primary); color:#fff; }
main { padding:12px; max-width:480px; margin:0 auto; }
.card { background:#fff; border-radius:12px; padding:12px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
.emp-name { font-weight:700; font-size:16px; }
.status { font-size:14px; color:#555; margin-top:4px; }
.btn { display:block; width:100%; padding:12px; margin-top:8px; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; }
.btn-in { background:var(--primary); color:#fff; }
.btn-out { background:var(--danger); color:#fff; }
.timer { font-size:14px; color:#333; margin-top:4px; font-weight:500; text-align:center; }
.progress-container { height:8px; background:#eee; border-radius:5px; margin-top:6px; overflow:hidden; }
.progress-bar { height:100%; width:0%; background:linear-gradient(90deg, #4caf50, #81c784); transition:width 1s linear; }
.muted { font-size:12px; color:#888; text-align:center; margin-top:4px; }
</style>
</head>
<body>

<header>
  <div id="tab-emp" class="tab active">Employee</div>
  <div id="tab-admin" class="tab">Admin</div>
</header>

<main>
<!-- Employee View -->
<section id="view-emp">
  <h2>Danh sách nhân viên</h2>
  <div id="emp-list"></div>
  <p class="muted">Lưu ý: Kiểm tra thiết bị & vị trí trước khi check-in/out.</p>
</section>

<!-- Admin View -->
<section id="view-admin" style="display:none">
  <h2>Admin Panel</h2>
  <div id="admin-list"></div>
</section>
</main>

<audio id="notif-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
// ===== Data =====
const EMPLOYEES = [{id:'E1',name:'Nhân viên 1'}]; // ví dụ 1 nhân viên
const BREAKS = [10,40,10,10]; // phút
const timers = {};

// ==== Device ID tự động ====
function getDeviceId(){
  let id = localStorage.getItem('deviceId');
  if(!id){
    id = btoa(navigator.userAgent + '|' + navigator.platform + '|' + Date.now()).slice(0,16);
    localStorage.setItem('deviceId', id);
  }
  return id;
}

// ==== Registry ====
function loadRegistry(){ return JSON.parse(localStorage.getItem('registry')||'{}'); }
function saveRegistry(reg){ localStorage.setItem('registry',JSON.stringify(reg)); }

// ==== Times & Break count ====
function getTimes(empId){ 
  const data = JSON.parse(localStorage.getItem('times')||'{}'); 
  return data[empId]||{breakIndex:0, ci:null, co:null}; 
}
function saveTimes(empId,times){
  const data = JSON.parse(localStorage.getItem('times')||'{}');
  data[empId] = times;
  localStorage.setItem('times',JSON.stringify(data));
}

// ==== Check In/Out with breaks ====
function getCurrentLocation(cb){
  if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(pos=>{
    cb(pos.coords.latitude+','+pos.coords.longitude);
  },()=>cb(null)); } else cb(null);
}
function doCheckIn(empId){
  const reg = loadRegistry();
  if(reg[empId]?.device!==getDeviceId()){ alert('Thiết bị không hợp lệ'); return; }
  getCurrentLocation(loc=>{
    const times = getTimes(empId);
    times.ci = new Date();
    saveTimes(empId,times);
    renderEmployees();
  });
}
function doCheckOut(empId){
  const reg = loadRegistry();
  if(reg[empId]?.device!==getDeviceId()){ alert('Thiết bị không hợp lệ'); return; }
  getCurrentLocation(loc=>{
    const times = getTimes(empId);
    const idx = times.breakIndex||0;
    if(idx>=BREAKS.length){ alert('Đã hết các lần nghỉ'); return; }
    alert(`Bắt đầu nghỉ lần ${idx+1}: ${BREAKS[idx]} phút`);
    times.breakIndex = idx+1;
    saveTimes(empId,times);
    startBreakCountdown(empId,BREAKS[idx]*60);
  });
}

// ==== Break countdown + notification ====
function startBreakCountdown(empId,seconds){
  const timerEl = document.getElementById(`timer-${empId}`);
  let remaining = seconds;
  const sound = document.getElementById('notif-sound');
  function tick(){
    if(remaining<=0){ 
      sound.play();
      alert(`Giờ nghỉ của ${empId} đã kết thúc!`);
      clearInterval(timers[empId]);
      timerEl.textContent = '';
      return;
    }
    const m = String(Math.floor(remaining/60)).padStart(2,'0');
    const s = String(remaining%60).padStart(2,'0');
    timerEl.textContent = `Đang nghỉ: ${m}:${s}`;
    remaining--;
  }
  tick();
  timers[empId] = setInterval(tick,1000);
}

// ==== Render Employees ====
function renderEmployees(){
  const empListEl = document.getElementById('emp-list');
  empListEl.innerHTML = '';
  const reg = loadRegistry();
  EMPLOYEES.forEach(emp=>{
    const times = getTimes(emp.id);
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <div class="emp-name">${emp.name} (${emp.id})</div>
      <div class="status">Lần nghỉ: ${times.breakIndex||0}/${BREAKS.length}</div>
      <button class="btn btn-in">Check In</button>
      <button class="btn btn-out">Check Out</button>
      <div class="timer" id="timer-${emp.id}"></div>
    `;
    card.querySelector('.btn-in').onclick=()=>doCheckIn(emp.id);
    card.querySelector('.btn-out').onclick=()=>doCheckOut(emp.id);
    empListEl.appendChild(card);
  });
}

// ==== Admin ====
function renderAdminList(){
  const listEl = document.getElementById('admin-list');
  listEl.innerHTML='';
  EMPLOYEES.forEach(emp=>{
    const btn = document.createElement('button');
    btn.textContent=`Gán thiết bị & vị trí cho ${emp.id}`;
    btn.onclick=()=>{
      getCurrentLocation(loc=>{
        const reg = loadRegistry();
        reg[emp.id] = {device:getDeviceId(), location:loc};
        saveRegistry(reg);
        alert(`Đã gán thiết bị & vị trí cho ${emp.id}`);
        renderEmployees();
      });
    };
    listEl.appendChild(btn);
  });
}

// ==== Tabs ====
document.getElementById('tab-emp').onclick = ()=>{
  document.getElementById('view-emp').style.display='block';
  document.getElementById('view-admin').style.display='none';
  document.getElementById('tab-emp').classList.add('active');
  document.getElementById('tab-admin').classList.remove('active');
};
document.getElementById('tab-admin').onclick = ()=>{
  document.getElementById('view-emp').style.display='none';
  document.getElementById('view-admin').style.display='block';
  document.getElementById('tab-admin').classList.add('active');
  document.getElementById('tab-emp').classList.remove('active');
  renderAdminList();
};

// ==== Init ====
renderEmployees();
</script>

</body>
</html>
