<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Check-in App">
<title>Check-in WebApp Mobile</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="manifest" href="manifest.json">
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
:root { 
  --primary:#2563eb; --danger:#dc2626; --ok:#16a34a; --bg:#f6f7fb; 
  --warn:#f59e0b; --gray-100:#f3f4f6; --gray-500:#6b7280; --gray-700:#374151;
  --text-light: #fff; --text-dark:#1f2937;
}
* { 
  box-sizing:border-box; margin:0; padding:0; 
  font-family:'Be Vietnam Pro', system-ui, Arial, sans-serif; 
}
body { background:var(--bg); color:var(--text-dark); font-size: 14px; }

/* Login View */
#login-view {
    display: flex; flex-direction: column; justify-content: center;
    align-items: center; height: 100vh; padding: 20px;
}
.login-box {
    background: white; padding: 24px; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center;
    width: 100%; max-width: 320px;
}
.login-box h2 { margin-bottom: 20px; font-size: 20px; }
.login-box input {
    width: 100%; padding: 12px; font-size: 16px; border-radius: 8px;
    border: 1px solid #ccc; margin-bottom: 12px; text-align: center;
}
.login-box button {
    width: 100%; padding: 12px; font-size: 16px; background: var(--primary);
    color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
}
#login-error { color: var(--danger); font-size: 14px; margin-top: 10px; height: 16px; }

/* MỚI: CSS cho camera đăng nhập */
#face-login-container {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 0 auto 20px auto;
}
#face-login-container video, #face-login-container canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    transform: scaleX(-1); /* Lật camera cho giống gương soi */
}
#login-status {
    font-size: 14px;
    color: var(--gray-700);
    min-height: 21px;
    margin-bottom: 10px;
}

/* Main App */
#app-container { display: none; }
header { 
  position:sticky; top:0; background:var(--text-light); 
  border-bottom:1px solid #e5e7eb; padding:8px; z-index:100; display:flex; align-items:center; gap:8px; 
}
.tabs-container { display: flex; flex-grow: 1; gap: 8px; }
.tab { 
  flex:1; text-align:center; padding:10px; border-radius:8px; 
  background:var(--gray-100); font-weight:600; cursor:pointer;
  transition: all 0.2s ease-in-out; font-size: 14px;
}
#logout-btn, #change-password-btn {
    background: none; border: none; font-size: 18px; color: var(--gray-500);
    cursor: pointer; padding: 8px;
}
main { padding:8px; max-width:480px; margin:0 auto; }
.card {
  background:var(--text-light); border-radius:8px; margin-bottom:6px; 
  box-shadow:0 1px 4px rgba(0,0,0,0.06); overflow:hidden;
  border: 1px solid #e5e7eb;
}
.card-header {
  display:flex; justify-content: space-between; align-items: center; gap:8px;
  padding: 6px 8px; border-bottom:1px solid var(--gray-100);
}
.emp-info { display: flex; align-items: center; gap: 8px; flex-grow: 1; overflow: hidden; }
.emp-name { 
    font-weight:600; font-size:14px; white-space: nowrap; overflow: hidden; 
    text-overflow: ellipsis; background-color: var(--gray-100);
    padding: 2px 8px; border-radius: 6px; color: var(--gray-700);
}
.status-badge { padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600; color: white; flex-shrink: 0; }
.status-working { background-color: var(--ok); }
.status-on-break { background-color: var(--warn); }
.status-pending { background-color: var(--gray-500); }
.status-scheduled { background-color: var(--primary); }
.card-body { 
    padding:8px; display: flex; justify-content: space-between;
    align-items: center; gap: 8px;
}
.status-section { display: flex; gap: 6px; flex-grow: 1; }
.status-item {
    background-color: var(--gray-100); padding: 4px 6px;
    border-radius: 4px; text-align: center; flex: 1;
}
.status-item-start { background-color: #e0e7ff; }
.status-item-break { background-color: #f0fdf4; }
.status-item.clickable { cursor: pointer; transition: background-color 0.2s; }
.status-item.clickable:hover { background-color: #e5e7eb; }
.status-item .label { font-weight: 500; color: var(--gray-500); font-size: 10px; }
.status-item .value { font-weight: 600; color: var(--text-dark); font-size: 12px; }
.action-buttons { 
    display: flex;
    justify-content: center;
    flex-shrink: 0; min-width: 80px;
}
.btn {
    padding: 6px 12px; border:none; border-radius:6px; 
    font-size:12px; font-weight:600; cursor:pointer;
    color: var(--text-light); width: 100%;
    transition: background-color 0.2s ease-in-out;
}
.btn-start-break { background: var(--warn); }
.btn-stop-break { background: var(--danger); }
.btn:disabled { background-color: #d1d5db; cursor: not-allowed; }

.break-visualizer { padding: 4px 8px; }
.timer-container { 
    display: none; width: 100%;
    background-color: #fef2f2; padding: 4px 8px; border-radius: 4px;
}
.timer-display { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
.timer-text { font-size:12px; color:var(--danger); font-weight:500; flex-shrink: 0;}
.progress-container { flex-grow: 1; height:6px; background:#e0e0e0; border-radius:5px; overflow:hidden; }
.progress-bar { height:100%; width:0%; background:var(--danger); transition:width 0.5s linear; }
.history-bars-container {
    display: flex; width: 100%; height: 8px;
    background-color: var(--gray-100); border-radius: 4px; overflow: hidden;
}
.history-bar-item { 
    height: 100%; 
    opacity: 0.8;
    cursor: pointer;
}

/* Admin UI & Modal */
.admin-section { padding: 12px; margin-bottom: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
.admin-section h3 { font-size: 16px; margin-bottom: 12px; border-bottom: 1px solid var(--gray-100); padding-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.form-group { margin-bottom: 10px; }
.form-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px; }
.form-group input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
.admin-btn { width: 100%; padding: 10px; font-size: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
.schedule-management-item, .emp-code-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 8px; background-color: var(--gray-100); margin-bottom: 8px; }
.schedule-management-item .name, .emp-code-item .name { font-weight: 600; }
.emp-code-item .code { font-family: monospace; font-size: 16px; background: #e0e7ff; padding: 2px 6px; border-radius: 4px; }
.schedule-group { display: flex; gap: 6px; align-items: center; }
.schedule-group input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 90px; }
.admin-icon-btn { padding: 8px; border: none; border-radius: 6px; cursor: pointer; color: white; width: 32px; height: 32px; text-align: center; line-height: 1; font-size: 14px;}
.btn-save-schedule { background: var(--ok); }
.btn-reset-breaks { background: var(--warn); }
.btn-view-stats { background: var(--primary); }
.btn-delete-emp { background: var(--danger); }

#modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; }
#modal { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
#modal-content { font-size: 15px; margin-bottom: 20px; color: var(--gray-700); text-align: left; }
#modal-content h3 { font-size: 16px; margin-bottom: 12px; text-align: center; }
#modal-content p { margin-bottom: 10px; }
#modal-content ul { list-style-type: none; padding-left: 0; }
#modal-content li { background-color: var(--gray-100); padding: 8px; border-radius: 6px; margin-bottom: 5px; }
#modal-ok { padding: 8px 16px; border-radius: 8px; border: none; background: var(--primary); color: white; font-size: 15px; cursor: pointer; }
</style>
</head>
<body>

<div id="login-view">
    <div class="login-box">
        <!-- MỚI: Giao diện cho camera đăng nhập -->
        <div id="face-login-container">
            <video id="login-video" autoplay muted playsinline></video>
            <canvas id="login-canvas"></canvas>
        </div>
        <p id="login-status">Đang khởi tạo camera...</p>
        
        <h2>Đăng nhập</h2>
        <input type="text" id="login-code-input" placeholder="...hoặc nhập mã số">
        <button id="login-btn">Đăng nhập bằng mã</button>
        <p id="login-error"></p>
    </div>
</div>

<div id="app-container">
    <header>
      <div class="tabs-container">
        <div id="tab-emp" class="tab active">Nhân viên</div>
        <div id="tab-admin" class="tab">Quản trị</div>
      </div>
      <button id="change-password-btn" title="Đổi mã đăng nhập"><i class="fa-solid fa-key"></i></button>
      <button id="logout-btn" title="Đăng xuất"><i class="fa-solid fa-right-from-bracket"></i></button>
    </header>

    <main>
    <section id="view-emp">
      <div id="emp-list"></div>
    </section>

    <section id="view-admin" style="display:none">
      <div id="admin-content"></div>
    </section>
    </main>
</div>


<div id="modal-backdrop">
    <div id="modal">
        <div id="modal-content"></div>
        <button id="modal-ok">OK</button>
    </div>
</div>
<audio id="notif-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<div id="face-modal-backdrop" style="position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; color: white;">
    <div id="face-modal-content" style="position: relative; background: #333; padding: 20px; border-radius: 12px; text-align: center;">
        <video id="video" width="300" height="225" autoplay muted playsinline></video>
        <canvas id="canvas" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%);"></canvas>
        <p id="face-modal-message" style="margin-top: 15px; font-size: 16px; min-height: 24px;">Đang tải model...</p>
        <button id="face-modal-close" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
    </div>
</div>

<script>
// ===== Data, State & Auth =====
const BREAKS = [10,40,10,10];
const timers = {};
let AppState = { employees: [], times: {}, loggedInUserId: null, isAdmin: false };

// ----- START: FACE RECOGNITION CODE -----
const faceModalBackdrop = document.getElementById('face-modal-backdrop');
const faceModalMessage = document.getElementById('face-modal-message');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
let modelsLoaded = false;
let currentFaceAction = { empId: null, actionType: null, callback: null };
let faceLoginMatcher = null; // MỚI: Biến lưu trữ FaceMatcher để đăng nhập

async function loadFaceModels() {
    if (modelsLoaded) return;
    faceModalMessage.textContent = 'Đang tải model...';
    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL) // MỚI: Thêm model này để tạo FaceMatcher
    ]);
    modelsLoaded = true;
    console.log("Face models loaded.");
}

async function startVideo(videoElement = video) { // MỚI: Cho phép chọn video element
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        videoElement.srcObject = stream;
        return new Promise(resolve => {
            videoElement.onloadedmetadata = () => resolve(videoElement);
        });
    } catch (err) {
        console.error("Camera Error:", err);
        return null;
    }
}

function stopVideoAndCloseModal(videoElement = video) { // MỚI: Cho phép chọn video element
    const stream = videoElement.srcObject;
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        videoElement.srcObject = null;
    }
    faceModalBackdrop.style.display = 'none';
    if (window.faceDetectionInterval) clearInterval(window.faceDetectionInterval);
    if (window.loginFaceInterval) clearInterval(window.loginFaceInterval);
}
document.getElementById('face-modal-close').onclick = () => stopVideoAndCloseModal(video);

async function handleFaceDetection() {
    // ... (Giữ nguyên hàm này cho việc đăng ký và xác thực)
    const displaySize = { width: video.width, height: video.height };
    faceapi.matchDimensions(canvas, displaySize);

    window.faceDetectionInterval = setInterval(async () => {
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        
        if (detections.length === 1) {
            const descriptor = detections[0].descriptor;
            if (currentFaceAction.actionType === 'register') {
                faceModalMessage.textContent = 'Đã nhận diện! Đang lưu...';
                const empIndex = AppState.employees.findIndex(e => e.id === currentFaceAction.empId);
                if (empIndex !== -1) {
                    AppState.employees[empIndex].faceDescriptor = Array.from(descriptor);
                    saveEmployees(AppState.employees);
                    stopVideoAndCloseModal();
                    showModal(`<h3>Thành công</h3><p>Đã đăng ký khuôn mặt cho ${AppState.employees[empIndex].name}.</p>`);
                    renderAdminPanel();
                }
                clearInterval(window.faceDetectionInterval);
            } else if (currentFaceAction.actionType === 'verify') {
                const emp = AppState.employees.find(e => e.id === currentFaceAction.empId);
                if (emp && emp.faceDescriptor) {
                    const storedDescriptor = new Float32Array(emp.faceDescriptor);
                    const distance = faceapi.euclideanDistance(descriptor, storedDescriptor);
                    
                    if (distance < 0.5) {
                        faceModalMessage.textContent = 'Xác thực thành công!';
                        clearInterval(window.faceDetectionInterval);
                        stopVideoAndCloseModal();
                        if (typeof currentFaceAction.callback === 'function') currentFaceAction.callback();
                    } else {
                        faceModalMessage.textContent = 'Không khớp. Thử lại!';
                    }
                } else {
                    faceModalMessage.textContent = 'Chưa đăng ký khuôn mặt!';
                }
            }
        } else if (detections.length > 1) {
            faceModalMessage.textContent = 'Vui lòng chỉ để 1 người trong khung hình.';
        } else {
            faceModalMessage.textContent = 'Đưa khuôn mặt vào khung hình...';
        }
    }, 300);
}

async function openFaceModal(empId, actionType, callback = null) {
    currentFaceAction = { empId, actionType, callback };
    faceModalBackdrop.style.display = 'flex';
    if (!modelsLoaded) await loadFaceModels();
    const videoEl = await startVideo();
    if (videoEl) handleFaceDetection();
}
// ----- END: FACE RECOGNITION CODE -----

// MỚI: Toàn bộ logic cho Đăng nhập bằng khuôn mặt
async function startFaceLoginScan() {
    const loginVideo = document.getElementById('login-video');
    const loginCanvas = document.getElementById('login-canvas');
    const loginStatus = document.getElementById('login-status');
    const faceLoginContainer = document.getElementById('face-login-container');

    faceLoginContainer.style.display = 'block';

    if (!modelsLoaded) {
        loginStatus.textContent = 'Đang tải model nhận diện...';
        await loadFaceModels();
    }
    
    // Tạo FaceMatcher từ dữ liệu nhân viên đã đăng ký
    const labeledDescriptors = AppState.employees
        .filter(emp => emp.faceDescriptor)
        .map(emp => new faceapi.LabeledFaceDescriptors(
            emp.id, [new Float32Array(emp.faceDescriptor)]
        ));

    if (labeledDescriptors.length === 0) {
        loginStatus.textContent = 'Chưa có nhân viên nào đăng ký khuôn mặt.';
        faceLoginContainer.style.display = 'none';
        return;
    }
    faceLoginMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);

    loginStatus.textContent = 'Đang khởi tạo camera...';
    const videoEl = await startVideo(loginVideo);

    if (!videoEl) {
        loginStatus.textContent = 'Lỗi camera. Vui lòng nhập mã.';
        faceLoginContainer.style.display = 'none';
        return;
    }

    loginStatus.textContent = 'Đưa khuôn mặt vào camera để đăng nhập.';
    const displaySize = { width: loginVideo.clientWidth, height: loginVideo.clientHeight };
    faceapi.matchDimensions(loginCanvas, displaySize);

    // Dừng quét sau 15 giây nếu không tìm thấy
    const timeout = setTimeout(() => {
        stopVideoAndCloseModal(loginVideo);
        loginStatus.textContent = 'Không nhận diện được. Vui lòng nhập mã.';
        faceLoginContainer.style.display = 'none';
    }, 15000);

    window.loginFaceInterval = setInterval(async () => {
        const detections = await faceapi.detectAllFaces(loginVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
        const resizedDetections = faceapi.resizeResults(detections, displaySize);
        loginCanvas.getContext('2d').clearRect(0, 0, loginCanvas.width, loginCanvas.height);
        faceapi.draw.drawDetections(loginCanvas, resizedDetections);
        
        if (detections.length === 1) {
            const bestMatch = faceLoginMatcher.findBestMatch(detections[0].descriptor);
            if (bestMatch.label !== 'unknown') {
                loginStatus.textContent = `Chào, ${AppState.employees.find(e => e.id === bestMatch.label).name}!`;
                clearInterval(window.loginFaceInterval);
                clearTimeout(timeout);
                stopVideoAndCloseModal(loginVideo);
                loginWithId(bestMatch.label); // Đăng nhập thành công!
            }
        }
    }, 500);
}


function generateInitialEmployees() { /* ... Giữ nguyên ... */ }

// MỚI: Tách hàm login thành 2 phần để tái sử dụng
function loginWithId(userId) {
    let userToLogin = userId;
    AppState.isAdmin = (userId === 'ADMIN');
    
    AppState.loggedInUserId = userToLogin;
    sessionStorage.setItem('loggedInUserId', userToLogin);
    
    document.getElementById('login-view').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
    
    updateUIVisibility();
    checkSchedules(true);
    renderEmployees();
}

function loginWithCode() {
    const code = document.getElementById('login-code-input').value;
    const errorEl = document.getElementById('login-error');
    if (!code) { errorEl.textContent = 'Vui lòng nhập mã số.'; return; }
    
    if (code === 'Admin') {
        loginWithId('ADMIN');
    } else {
        const employee = AppState.employees.find(e => e.code == code);
        if (employee) { 
            loginWithId(employee.id);
        } else {
            errorEl.textContent = 'Mã số không hợp lệ.'; 
        }
    }
}

function logout() {
    AppState.loggedInUserId = null;
    AppState.isAdmin = false;
    sessionStorage.removeItem('loggedInUserId');
    document.getElementById('app-container').style.display = 'none';
    document.getElementById('login-view').style.display = 'flex';
    document.getElementById('login-code-input').value = '';
    document.getElementById('login-error').textContent = '';
    updateUIVisibility();
    startFaceLoginScan(); // MỚI: Bắt đầu quét khuôn mặt khi logout
}

function updateUIVisibility() { /* ... Giữ nguyên ... */ }
function loadData() { /* ... Giữ nguyên ... */ }
function saveEmployees(employees) { localStorage.setItem('employees', JSON.stringify(employees)); AppState.employees = employees; }
function saveTimes() { /* ... Giữ nguyên ... */ }
function getTimes(empId) { /* ... Giữ nguyên ... */ }
function showModal(htmlContent, onOk) { /* ... Giữ nguyên ... */ }
modalOk.onclick = () => { /* ... Giữ nguyên ... */ };
function formatSeconds(seconds) { /* ... Giữ nguyên ... */ }
function getWorkDayString(date) { /* ... Giữ nguyên ... */ }
function loadLocationSettings() { /* ... Giữ nguyên ... */ }
function saveLocationSettings() { /* ... Giữ nguyên ... */ }
function calculateDistance(lat1, lon1, lat2, lon2) { /* ... Giữ nguyên ... */ }
function performActionWithLocationCheck(actionCallback) { /* ... Giữ nguyên ... */ }
async function requestNotificationPermission() { /* ... Giữ nguyên ... */ }
function showBrowserNotification(title, body) { /* ... Giữ nguyên ... */ }
function showChangePasswordModal() { /* ... Giữ nguyên ... */ }

function startBreak(empId){
    const emp = AppState.employees.find(e => e.id === empId);
    if (!emp || !emp.faceDescriptor) {
        showModal("<h3>Yêu cầu</h3><p>Bạn cần đăng ký khuôn mặt trước khi sử dụng tính năng này. Vui lòng liên hệ quản trị viên.</p>");
        return;
    }
    const actionCallback = () => {
        const times = getTimes(empId);
        const idx = times.breakIndex || 0;
        if(idx >= BREAKS.length){ showModal('<h3>Thông báo</h3><p>Đã hết số lần nghỉ giải lao trong ngày.</p>'); return; }
        showModal(`<h3>Xác nhận</h3><p>Bắt đầu nghỉ lần ${idx+1}: ${BREAKS[idx]} phút?</p>`, () => {
            times.onBreak = true; times.breakStartTime = new Date().toISOString();
            times.breakIndex = idx + 1; AppState.times[empId] = times; 
            saveTimes();
            renderEmployees();
        });
    };
    openFaceModal(empId, 'verify', () => performActionWithLocationCheck(actionCallback));
}
function recordBreak(empId) { /* ... Giữ nguyên ... */ }
function stopBreak(empId) {
    const emp = AppState.employees.find(e => e.id === empId);
    if (!emp || !emp.faceDescriptor) {
        showModal("<h3>Lỗi</h3><p>Không tìm thấy dữ liệu khuôn mặt. Vui lòng liên hệ quản trị viên.</p>");
        return;
    }
    const actionCallback = () => {
        if (timers[empId]) { clearInterval(timers[empId]); delete timers[empId]; }
        const times = getTimes(empId);
        if (!times.onBreak) return;
        recordBreak(empId);
        times.onBreak = false; AppState.times[empId] = times;
        saveTimes(); renderEmployees();
    };
    openFaceModal(empId, 'verify', () => performActionWithLocationCheck(actionCallback));
}
function startBreakCountdown(empId){ /* ... Giữ nguyên ... */ }
function showBreakDetailModal(index, duration) { /* ... Giữ nguyên ... */ }
function renderEmployees(){ /* ... Giữ nguyên ... */ }
function viewBreakStatsAdmin(empId) { /* ... Giữ nguyên ... */ }
function resetBreaks(empId) { /* ... Giữ nguyên ... */ }
function addEmployee() { /* ... Giữ nguyên ... */ }
function saveSchedule(empId) { /* ... Giữ nguyên ... */ }
function deleteEmployee(empId) { /* ... Giữ nguyên ... */ }

function renderAdminPanel(){
  const adminContentEl = document.getElementById('admin-content');
  let addEmployeeHtml = `<div class="admin-section"><h3><i class="fa-solid fa-user-plus"></i> Thêm nhân viên mới</h3>
    <div class="form-group"><label>Tên nhân viên</label><input type="text" id="new-emp-name"></div>
    <div class="form-group"><label>ID nhân viên</label><input type="text" id="new-emp-id"></div>
    <div class="form-group"><label>Mã số đăng nhập</label><input type="text" inputmode="numeric" id="new-emp-code"></div>
    <button class="admin-btn" onclick="addEmployee()">Thêm nhân viên</button></div>`;
    
  let locationSettingsHtml = `<div class="admin-section"><h3><i class="fa-solid fa-map-marker-alt"></i> Cài đặt Vị trí</h3>
    <div class="form-group"><label>Vĩ độ (Latitude)</label><input type="number" step="any" id="setting-lat"></div>
    <div class="form-group"><label>Kinh độ (Longitude)</label><input type="number" step="any" id="setting-lon"></div>
    <div class="form-group"><label>Bán kính cho phép (mét)</label><input type="number" id="setting-radius" value="30"></div>
    <button class="admin-btn" onclick="saveLocationSettings()">Lưu Cài đặt Vị trí</button></div>`;
    
  let scheduleHtml = `<div class="admin-section"><h3><i class="fa-solid fa-clock"></i> Quản lý Nhân viên</h3>`;
  if (AppState.employees.length > 0) {
    [...AppState.employees].sort((a, b) => a.name.localeCompare(b.name)).forEach(emp => {
        const times = getTimes(emp.id);
        const faceRegistered = emp.faceDescriptor && emp.faceDescriptor.length > 0;
        const faceBtnColor = faceRegistered ? 'var(--ok)' : 'var(--primary)';
        const faceBtnIcon = faceRegistered ? 'fa-solid fa-user-check' : 'fa-solid fa-camera';
        const faceBtnTitle = faceRegistered ? 'Đăng ký lại khuôn mặt' : 'Đăng ký khuôn mặt';

        scheduleHtml += `<div class="schedule-management-item"><span class="name">${emp.name} (${emp.id})</span><div class="schedule-group">
            <input type="time" id="schedule-${emp.id}" value="${times.scheduledTime || ''}">
            <button class="admin-icon-btn" style="background-color: ${faceBtnColor};" onclick="openFaceModal('${emp.id}', 'register')" title="${faceBtnTitle}"><i class="${faceBtnIcon}"></i></button>
            <button class="admin-icon-btn btn-save-schedule" onclick="saveSchedule('${emp.id}')" title="Lưu lịch"><i class="fa-solid fa-save"></i></button>
            <button class="admin-icon-btn btn-view-stats" onclick="viewBreakStatsAdmin('${emp.id}')" title="Xem thống kê"><i class="fa-solid fa-chart-simple"></i></button>
            <button class="admin-icon-btn btn-reset-breaks" onclick="resetBreaks('${emp.id}')" title="Reset nghỉ"><i class="fa-solid fa-rotate-left"></i></button>
            <button class="admin-icon-btn btn-delete-emp" onclick="deleteEmployee('${emp.id}')" title="Xóa nhân viên"><i class="fa-solid fa-trash"></i></button>
        </div></div>`;
    });
  } else { scheduleHtml += '<p>Chưa có nhân viên nào.</p>'; }
  scheduleHtml += `</div>`;
  let codesHtml = `<div class="admin-section"><h3><i class="fa-solid fa-key"></i> Mã số Đăng nhập</h3>`;
  if (AppState.employees.length > 0) {
    [...AppState.employees].sort((a, b) => a.name.localeCompare(b.name)).forEach(emp => {
        codesHtml += `<div class="emp-code-item"><span class="name">${emp.name}</span><span class="code">${emp.code}</span></div>`;
    });
  } else { codesHtml += '<p>Chưa có nhân viên nào.</p>'; }
  codesHtml += `</div>`;
  adminContentEl.innerHTML = addEmployeeHtml + locationSettingsHtml + scheduleHtml + codesHtml;

  const settings = loadLocationSettings();
  if (settings) {
    document.getElementById('setting-lat').value = settings.lat;
    document.getElementById('setting-lon').value = settings.lon;
    document.getElementById('setting-radius').value = settings.radius;
  }
}

function checkSchedules(isLogin = false) { /* ... Giữ nguyên ... */ }
document.getElementById('tab-emp').onclick = ()=>{ /* ... Giữ nguyên ... */ };
document.getElementById('tab-admin').onclick = ()=>{ /* ... Giữ nguyên ... */ };
// MỚI: Cập nhật sự kiện click của nút login
document.getElementById('login-btn').onclick = loginWithCode;
document.getElementById('logout-btn').onclick = logout;
document.getElementById('change-password-btn').onclick = showChangePasswordModal;
document.getElementById('login-code-input').addEventListener('keyup', (event) => {
    if (event.key === 'Enter') loginWithCode();
});

async function initializeApp() {
    await requestNotificationPermission();
    loadData();
    const loggedInId = sessionStorage.getItem('loggedInUserId');
    if (loggedInId) {
        AppState.loggedInUserId = loggedInId;
        AppState.isAdmin = (loggedInId === 'ADMIN');
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        updateUIVisibility();
        checkSchedules(true);
        renderEmployees();
    } else {
        document.getElementById('login-view').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
        startFaceLoginScan(); // MỚI: Bắt đầu quét khuôn mặt khi mở app
    }
    setInterval(() => checkSchedules(false), 5000);
    loadFaceModels(); // Tải trước các model nhận diện
}
initializeApp();

</script>

</body>
</html>
